<!doctype html> <html> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="chrome=1"> <title>Zp Yuan layout机制（顺便复习模板机制）</title> <link href="/bundle-1857e13f.css" rel=stylesheet /> <meta name=viewport content="width=device-width"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head> <body> <div class=wrapper> <header> <ul> <li class=current><a href="/index.html"><strong>笔记</strong></a></li> <li><a href="/statistics.html"><strong>统计</strong></a></li> <li><a href="/about.html"><strong>关于</strong></a></li> </ul> <div class=tags> <ol> <li> <a class=post-tag href="/index.html?tag=ruby"> <span>ruby</span> <span>61</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rails"> <span>rails</span> <span>31</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=metaprogramming"> <span>metaprogramming</span> <span>12</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=versus"> <span>versus</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=sinatra"> <span>sinatra</span> <span>7</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=test"> <span>test</span> <span>5</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rack"> <span>rack</span> <span>4</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=minitest"> <span>minitest</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=debug"> <span>debug</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=concurrency"> <span>concurrency</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=pattern"> <span>pattern</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=javascript"> <span>javascript</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jekyll"> <span>jekyll</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=middleman"> <span>middleman</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=functional"> <span>functional</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=tilt"> <span>tilt</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jquery"> <span>jquery</span> <span>1</span> </a> </li> </ol> </div> </header> <section> <article> <h1 class=post-title>layout机制（顺便复习模板机制）</h1> <span class=post-date>2017-05-14</span> <a class=post-tag href="/index.html?tag=rails">rails</a> <a class=post-tag href="/index.html?tag=ruby">ruby</a> <div> <span><div>在application.html.erb中加入binding.pry</div> <div><br></div> <div class=ever-code><pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Pragprog Books Online Store&lt;/title&gt;
    &lt;%= csrf_meta_tags %&gt;

    &lt;%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %&gt;
    &lt;%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %&gt;
  &lt;/head&gt;
  &lt;body class="&lt;%= controller.controller_name %&gt;"&gt;

      &lt;% binding.pry %&gt;
      &lt;div id="main"&gt;
        &lt;%= yield %&gt;
      &lt;/div&gt;
    &lt;/div&gt;

  &lt;/body&gt;
&lt;/html&gt;</code></pre></div> <div><br></div> <div><br></div> <div>得调用栈如下</div> <div><br></div> <div class=ever-code><pre><code>[1] pry(#&lt;#&lt;Class:0x007f69cf29f9d8&gt;&gt;)&gt; _bsi_
=&gt; {0=&gt;#&lt;Binding:70045758642500 #&lt;Class:0x007f69cf29f9d8&gt;#_app_views_layouts_application_html_erb___3541629653556534568_70046211675620 /home/z/test_rails/depot/app/views/layouts/application.html.erb:39&gt;,
 1=&gt;#&lt;Binding:70045759069160 ActionView::Template#block in render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/template.rb:159&gt;,
 2=&gt;#&lt;Binding:70045759503020 ActiveSupport::Notifications.instrument /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/notifications.rb:166&gt;,
 3=&gt;#&lt;Binding:70045759928860 ActionView::Template#instrument /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/template.rb:354&gt;,
 4=&gt;#&lt;Binding:70045760340680 ActionView::Template#render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/template.rb:157&gt;,
 5=&gt;#&lt;Binding:70045760696120 ActionView::TemplateRenderer#render_with_layout /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/template_renderer.rb:66&gt;,
 6=&gt;#&lt;Binding:70045761106380 ActionView::TemplateRenderer#render_template /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/template_renderer.rb:52&gt;,
 7=&gt;#&lt;Binding:70045761507620 ActionView::TemplateRenderer#render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/template_renderer.rb:14&gt;,
 8=&gt;#&lt;Binding:70045761924980 ActionView::Renderer#render_template /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/renderer.rb:42&gt;,
 9=&gt;#&lt;Binding:70045762326140 ActionView::Renderer#render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/renderer.rb:23&gt;,
 10=&gt;#&lt;Binding:70045762736120 StoreController#_render_template /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/rendering.rb:104&gt;,
 11=&gt;#&lt;Binding:70045763147920 StoreController#_render_template /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/streaming.rb:217&gt;,
 12=&gt;#&lt;Binding:70045763278200 StoreController#render_to_body /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/rendering.rb:83&gt;,
 13=&gt;#&lt;Binding:70045763450580 StoreController#render_to_body /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/rendering.rb:52&gt;,
 14=&gt;#&lt;Binding:70045763843520 StoreController#render_to_body /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/renderers.rb:142&gt;,
 15=&gt;#&lt;Binding:70045764050280 StoreController#render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/abstract_controller/rendering.rb:26&gt;,
 16=&gt;#&lt;Binding:70045764197340 StoreController#render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/rendering.rb:36&gt;,
 17=&gt;#&lt;Binding:70045764518340 StoreController#block (2 levels) in render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:44&gt;,
 18=&gt;#&lt;Binding:70045765647320 Benchmark.block in ms /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/core_ext/benchmark.rb:12&gt;,
 19=&gt;#&lt;Binding:70045765803580 Benchmark.realtime /home/z/.rbenv/versions/2.4.0/lib/ruby/2.4.0/benchmark.rb:308&gt;,
 20=&gt;#&lt;Binding:70045765911640 Benchmark.ms /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/core_ext/benchmark.rb:12&gt;,
 21=&gt;#&lt;Binding:70045765993640 StoreController#block in render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:44&gt;,
 22=&gt;#&lt;Binding:70045766068960 StoreController#cleanup_view_runtime /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:87&gt;,
 23=&gt;#&lt;Binding:70045767595920 StoreController#cleanup_view_runtime /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activerecord-5.0.2/lib/active_record/railties/controller_runtime.rb:25&gt;,
 24=&gt;#&lt;Binding:70045767620700 StoreController#render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:43&gt;,
 25=&gt;#&lt;Binding:70045767654740 StoreController#default_render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/implicit_render.rb:36&gt;,
 26=&gt;#&lt;Binding:70045765986380 StoreController#block in send_action /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/basic_implicit_render.rb:4&gt;,
 27=&gt;#&lt;Binding:70045765964560 StoreController#send_action /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/basic_implicit_render.rb:4&gt;,
 28=&gt;#&lt;Binding:70045765950940 StoreController#process_action /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/abstract_controller/base.rb:188&gt;,
 29=&gt;#&lt;Binding:70045767747820 StoreController#process_action /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/rendering.rb:30&gt;,
 30=&gt;#&lt;Binding:70045767783320 StoreController#block in process_action /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/abstract_controller/callbacks.rb:20&gt;,</code></pre></div> <div><br></div> <div><br></div> <div>其上一层，也就是ActionView::Template#block in render，是这样的</div> <div><br></div> <div class=ever-code><pre><code>def render(view, locals, buffer=nil, &amp;block)
  instrument("!render_template".freeze) do
    compile!(view)
    view.send(method_name, locals, buffer, &amp;block)
  end
rescue =&gt; e
  handle_render_error(view, e)
end</code></pre></div> <div><br></div> <div><br></div> <div>如无意外，就跟之前研究过的“sinatra如何利用tilt来render”一样，基本上就是，用erb（如果模板是erb）来将模板转换成一个method，method所绑定的对象（即view），带有controller的实例变量，并且该method可接收额外的局部变量</div> <div><br></div> <div>于是稍微验证一下</div> <div><br></div> <div>首先，compile!所做的就是给view加上method</div> <div><br></div> <div class=ever-code><pre><code># actionview-5.0.2/lib/action_view/template.rb
def compile(mod)
  encode!
  method_name = self.method_name
  code = @handler.call(self)

  # Make sure that the resulting String to be eval'd is in the
  # encoding of the code
  source = &lt;&lt;-end_src
    def #{method_name}(local_assigns, output_buffer)
      _old_virtual_path, @virtual_path = @virtual_path, #{@virtual_path.inspect};_old_output_buffer = @output_buffer;#{locals_code};#{code}
    ensure
      @virtual_path, @output_buffer = _old_virtual_path, _old_output_buffer
    end
  end_src

  # Make sure the source is in the encoding of the returned code
  source.force_encoding(code.encoding)

  # In case we get back a String from a handler that is not in
  # BINARY or the default_internal, encode it to the default_internal
  source.encode!

  # Now, validate that the source we got back from the template
  # handler is valid in the default_internal. This is for handlers
  # that handle encoding but screw up
  unless source.valid_encoding?
    raise WrongEncodingError.new(@source, Encoding.default_internal)
  end

  mod.module_eval(source, identifier, 0)
  ObjectSpace.define_finalizer(self, Finalizer[method_name, mod])
end

def compile(mod) #:nodoc:
  encode!
  method_name = self.method_name
  code = @handler.call(self)

  # Make sure that the resulting String to be eval'd is in the
  # encoding of the code
  source = &lt;&lt;-end_src
    def #{method_name}(local_assigns, output_buffer)
      _old_virtual_path, @virtual_path = @virtual_path, #{@virtual_path.inspect};_old_output_buffer = @output_buffer;#{locals_code};#{code}
    ensure
      @virtual_path, @output_buffer = _old_virtual_path, _old_output_buffer
    end
  end_src

  # Make sure the source is in the encoding of the returned code
  source.force_encoding(code.encoding)

  # In case we get back a String from a handler that is not in
  # BINARY or the default_internal, encode it to the default_internal
  source.encode!

  # Now, validate that the source we got back from the template
  # handler is valid in the default_internal. This is for handlers
  # that handle encoding but screw up
  unless source.valid_encoding?
    raise WrongEncodingError.new(@source, Encoding.default_internal)
  end

  mod.module_eval(source, identifier, 0)
  ObjectSpace.define_finalizer(self, Finalizer[method_name, mod])
end</code></pre></div> <div><br></div> <div><br></div> <div>而这个method中，生成最终html（如果你是返回html）的code，来自@handler.call(self)。于是检查下handler是啥</div> <div><br></div> <div class=ever-code><pre><code>[10] pry(#&lt;#&lt;Class:0x007f69cf29f9d8&gt;&gt;)&gt; _bsi_[1].eval("handler.class")
=&gt; ActionView::Template::Handlers::ERB</code></pre></div> <div><br></div> <div><br></div> <div>其源码如下</div> <div><br></div> <div class=ever-code><pre><code># actionview-5.0.2/lib/action_view/template/handlers/erb.rb
def call(template)
  # First, convert to BINARY, so in case the encoding is
  # wrong, we can still find an encoding tag
  # (&lt;%# encoding %&gt;) inside the String using a regular
  # expression
  template_source = template.source.dup.force_encoding(Encoding::ASCII_8BIT)

  erb = template_source.gsub(ENCODING_TAG, '')
  encoding = $2

  erb.force_encoding valid_encoding(template.source.dup, encoding)

  # Always make sure we return a String in the default_internal
  erb.encode!

  self.class.erb_implementation.new(
    erb,
    :escape =&gt; (self.class.escape_whitelist.include? template.type),
    :trim =&gt; (self.class.erb_trim_mode == "-")
  ).src
end</code></pre></div> <div><br></div> <div><br></div> <div>而handler则是，初始化view的时候就赋予的（其实这不重要）</div> <div><br></div> <div class=ever-code><pre><code># actionview-5.0.2/lib/action_view/template.rb
attr_reader :source, :identifier, :handler, :original_encoding, :updated_at

def initialize(source, identifier, handler, details)
  format = details[:format] || (handler.default_format if handler.respond_to?(:default_format))

  @source            = source
  @identifier        = identifier
  @handler           = handler
  @compiled          = false
  @original_encoding = nil
  @locals            = details[:locals] || []
  @virtual_path      = details[:virtual_path]
  @updated_at        = details[:updated_at] || Time.now
  @formats           = Array(format).map { |f| f.respond_to?(:ref) ? f.ref : f  }
  @variants          = [details[:variant]]
  @compile_mutex     = Mutex.new
end</code></pre></div> <div><br></div> <div><br></div> <div>那么，回到如何找layout的问题上，从调用栈可见，这个过程应是如下</div> <div><br></div> <div class=ever-code><pre><code> 5=&gt;#&lt;Binding:70045760696120 ActionView::TemplateRenderer#render_with_layout /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/template_renderer.rb:66&gt;,
 6=&gt;#&lt;Binding:70045761106380 ActionView::TemplateRenderer#render_template /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/template_renderer.rb:52&gt;,
 7=&gt;#&lt;Binding:70045761507620 ActionView::TemplateRenderer#render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/template_renderer.rb:14&gt;,
 8=&gt;#&lt;Binding:70045761924980 ActionView::Renderer#render_template /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/renderer.rb:42&gt;,
 9=&gt;#&lt;Binding:70045762326140 ActionView::Renderer#render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/renderer.rb:23&gt;,</code></pre></div> <div><br></div> <div><br></div> <div>都在TemplateRenderer中</div> <div><br></div> <div class=ever-code><pre><code>module ActionView
  class TemplateRenderer &lt; AbstractRenderer
    def render(context, options)
      @view    = context
      @details = extract_details(options)
      template = determine_template(options)

      prepend_formats(template.formats)

      @lookup_context.rendered_format ||= (template.formats.first || formats.first)

      render_template(template, options[:layout], options[:locals])
    end

    def render_template(template, layout_name = nil, locals = nil)
      view, locals = @view, locals || {}

      render_with_layout(layout_name, locals) do |layout|
        instrument(:template, :identifier =&gt; template.identifier, :layout =&gt; layout.try(:virtual_path)) do
          template.render(view, locals) { |*name| view._layout_for(*name) }
        end
      end
    end

    def render_with_layout(path, locals)
      layout  = path &amp;&amp; find_layout(path, locals.keys, [formats.first])
      content = yield(layout)

      if layout
        view = @view
        view.view_flow.set(:layout, content)
        layout.render(view, locals){ |*name| view._layout_for(*name) }
      else
        content
      end
    end
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>那么这里的options[:layout]是什么呢</div> <div><br></div> <div class=ever-code><pre><code>[13] pry(#&lt;#&lt;Class:0x007f69cf29f9d8&gt;&gt;)&gt; _bsi_[7].lv(:options)
=&gt; {:prefixes=&gt;["store", "application"], :template=&gt;"index", :layout=&gt;#&lt;Proc:0x007f69cf29fd70@/home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/layouts.rb:386&gt;}</code></pre></div> <div><br></div> <div><br></div> <div>这里好像有点不对劲了，才发现现在断点就是在application.html.erb这个layout上，那就不好分析了，还是断在内容上吧，于是</div> <div><br></div> <div class=ever-code><pre><code>&lt;!-- depot/app/views/store/index.html.erb --&gt;
&lt;p id="notice"&gt;&lt;%= notice %&gt;&lt;/p&gt;

&lt;h1&gt;Your Pragmatic Catalog&lt;/h1&gt;

&lt;% @products.each do |product| %&gt;
  &lt;div class="entry"&gt;
  &lt;%= image_tag(product.image_url) %&gt;
  &lt;h3&gt;&lt;%= product.title %&gt;&lt;/h3&gt;
  &lt;%= sanitize(product.description) %&gt;
  &lt;div class="price_line"&gt;
    &lt;span class="price"&gt;&lt;%=  number_to_currency product.price %&gt;&lt;/span&gt;
    &lt;%= button_to 'Add to Cart', line_items_path(product_id: product), remote: true %&gt;
  &lt;/div&gt;
  &lt;/div&gt;
&lt;% end %&gt;

&lt;% binding.pry %&gt;</code></pre></div> <div><br></div> <div><br></div> <div>得调用栈如下</div> <div><br></div> <div class=ever-code><pre><code>[1] pry(#&lt;#&lt;Class:0x007f69cf29f9d8&gt;&gt;)&gt; _bsi_
=&gt; {0=&gt;#&lt;Binding:70045772081600 #&lt;Class:0x007f69cf29f9d8&gt;#_app_views_store_index_html_erb__2763356708539799932_70045772484440 /home/z/test_rails/depot/app/views/store/index.html.erb:17&gt;,
 1=&gt;#&lt;Binding:70045772032120 ActionView::Template#block in render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/template.rb:159&gt;,
 2=&gt;#&lt;Binding:70045771966320 ActiveSupport::Notifications.instrument /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/notifications.rb:166&gt;,
 3=&gt;#&lt;Binding:70045771908740 ActionView::Template#instrument /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/template.rb:354&gt;,
 4=&gt;#&lt;Binding:70045771842300 ActionView::Template#render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/template.rb:157&gt;,
 5=&gt;#&lt;Binding:70045771792900 ActionView::TemplateRenderer#block (2 levels) in render_template /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/template_renderer.rb:54&gt;,
 6=&gt;#&lt;Binding:70045771759860 ActionView::TemplateRenderer#block in instrument /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/abstract_renderer.rb:42&gt;,
 7=&gt;#&lt;Binding:70045771686380 ActiveSupport::Notifications.block in instrument /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/notifications.rb:164&gt;,
 8=&gt;#&lt;Binding:70045771621060 ActiveSupport::Notifications::Instrumenter#instrument /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/notifications/instrumenter.rb:21&gt;,
 9=&gt;#&lt;Binding:70045771555580 ActiveSupport::Notifications.instrument /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/notifications.rb:164&gt;,
 10=&gt;#&lt;Binding:70045771490240 ActionView::TemplateRenderer#instrument /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/abstract_renderer.rb:41&gt;,
 11=&gt;#&lt;Binding:70045771416660 ActionView::TemplateRenderer#block in render_template /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/template_renderer.rb:53&gt;,
 12=&gt;#&lt;Binding:70045771351340 ActionView::TemplateRenderer#render_with_layout /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/template_renderer.rb:61&gt;,
 13=&gt;#&lt;Binding:70045771285860 ActionView::TemplateRenderer#render_template /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/template_renderer.rb:52&gt;,
 14=&gt;#&lt;Binding:70045771219460 ActionView::TemplateRenderer#render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/template_renderer.rb:14&gt;,
 15=&gt;#&lt;Binding:70045771143900 ActionView::Renderer#render_template /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/renderer.rb:42&gt;,
 16=&gt;#&lt;Binding:70045771069940 ActionView::Renderer#render /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/renderer/renderer.rb:23&gt;,</code></pre></div> <div><br></div> <div><br></div> <div>但发现options[:layout]仍然是如此一个Proc</div> <div><br></div> <div class=ever-code><pre><code>[2] pry(#&lt;#&lt;Class:0x007f69cf29f9d8&gt;&gt;)&gt; _bsi_[14].lv(:options)
=&gt; {:prefixes=&gt;["store", "application"], :template=&gt;"index", :layout=&gt;#&lt;Proc:0x007f699ac616b8@/home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/layouts.rb:386&gt;}
[3] pry(#&lt;#&lt;Class:0x007f69cf29f9d8&gt;&gt;)&gt; _bsi_[13].lv(:layout_name)
=&gt; #&lt;Proc:0x007f699ac616b8@/home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/layouts.rb:386&gt;</code></pre></div> <div><br></div> <div><br></div> <div>但回过头来看，render_template和render_with_layout分别有以下两句</div> <div><br></div> <div class=ever-code><pre><code>template.render(view, locals) { |*name| view._layout_for(*name) }
layout.render(view, locals){ |*name| view._layout_for(*name) }</code></pre></div> <div><br></div> <div><br></div> <div>于是，大概可以这样猜测：当前的view在render时，会找出layout对象（它也是一个view），然后调用layout的render，并带上一个block，在block中调用当前view的render；当layout所转换成的method中调用yield时，即调用了当前view的render，于是layout便嵌套了当前view。</div> <div><br></div> <div>理论上这是可行的，但真要去验证actionview的具体做法的话……好像太麻烦了，先不干了……</div></span> </div> </article> </section> <footer> </footer> </div> <script src="/javascripts/bundle-853f63ec.js"></script> </body> </html>