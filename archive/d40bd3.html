<!doctype html> <html> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="chrome=1"> <title>Zp Yuan delete与destroy</title> <link href="/bundle-1857e13f.css" rel=stylesheet /> <meta name=viewport content="width=device-width"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head> <body> <div class=wrapper> <header> <ul> <li class=current><a href="/index.html"><strong>笔记</strong></a></li> <li><a href="/statistics.html"><strong>统计</strong></a></li> <li><a href="/about.html"><strong>关于</strong></a></li> </ul> <div class=tags> <ol> <li> <a class=post-tag href="/index.html?tag=ruby"> <span>ruby</span> <span>61</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rails"> <span>rails</span> <span>31</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=metaprogramming"> <span>metaprogramming</span> <span>12</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=versus"> <span>versus</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=sinatra"> <span>sinatra</span> <span>7</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=test"> <span>test</span> <span>5</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rack"> <span>rack</span> <span>4</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=minitest"> <span>minitest</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=debug"> <span>debug</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=concurrency"> <span>concurrency</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=pattern"> <span>pattern</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=javascript"> <span>javascript</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jekyll"> <span>jekyll</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=middleman"> <span>middleman</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=functional"> <span>functional</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=tilt"> <span>tilt</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jquery"> <span>jquery</span> <span>1</span> </a> </li> </ol> </div> </header> <section> <article> <h1 class=post-title>delete与destroy</h1> <span class=post-date>2017-04-27</span> <a class=post-tag href="/index.html?tag=rails">rails</a> <a class=post-tag href="/index.html?tag=ruby">ruby</a> <a class=post-tag href="/index.html?tag=versus">versus</a> <div> <span><div>简单总结，destroy会在一个transaction中检查关联对象和callback，而delete直接删记录</div> <div><br></div> <div>delete是有分实例方法和类方法的，实例方法会重用类方法</div> <div><br></div> <div class=ever-code><pre><code># activerecord-5.0.2/lib/active_record/persistence.rb
def delete
  self.class.delete(id) if persisted?
  @destroyed = true
  freeze
end</code></pre></div> <div><br></div> <div><br></div> <div>实例的delete，完整调用栈如下</div> <div><br></div> <div><a href="/images/d40bd3/0451a4.html" target=_blank><img src="/images/d40bd3/bd391b.png" alt="instance_delete.html"></a></div> <div><br></div> <div>简略来看是这样</div> <div><br></div> <div><a href="/images/d40bd3/50e19f.png" target=_blank><img src="/images/d40bd3/50e19f.png" type="image/png" style="height: auto;"></a></div> <div><br></div> <div>最终的delete_all如下，它只是发起一条delete语句，并不涉及关联对象或自定义callback</div> <div><br></div> <div class=ever-code><pre><code>def delete_all(conditions = nil)
  invalid_methods = INVALID_METHODS_FOR_DELETE_ALL.select { |method|
    if MULTI_VALUE_METHODS.include?(method)
      send("#{method}_values").any?
    elsif SINGLE_VALUE_METHODS.include?(method)
      send("#{method}_value")
    elsif CLAUSE_METHODS.include?(method)
      send("#{method}_clause").any?
    end
  }
  if invalid_methods.any?
    raise ActiveRecordError.new("delete_all doesn't support #{invalid_methods.join(', ')}")
  end

  if conditions
    ActiveSupport::Deprecation.warn(&lt;&lt;-MESSAGE.squish)
      Passing conditions to delete_all is deprecated and will be removed in Rails 5.1.
      To achieve the same use where(conditions).delete_all.
    MESSAGE
    where(conditions).delete_all
  else
    stmt = Arel::DeleteManager.new
    stmt.from(table)

    if joins_values.any?
      @klass.connection.join_to_delete(stmt, arel, arel_attribute(primary_key))
    else
      stmt.wheres = arel.constraints
    end

    affected = @klass.connection.delete(stmt, 'SQL', bound_attributes)

    reset
    affected
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>而destory则是套在transaction和callback之中</div> <div><br></div> <div><a href="/images/d40bd3/de83bd.png" target=_blank><img src="/images/d40bd3/de83bd.png" type="image/png" style="height: auto;"></a></div> <div><br></div> <div>准确来说，是include module Persistence之后，还有include Callbacks和Transactions</div> <div><br></div> <div>activerecord-5.0.2/lib/active_record/transactions.rb如下</div> <div><br></div> <div class=ever-code><pre><code>def destroy
  with_transaction_returning_status { super }
end</code></pre></div> <div><br></div> <div><br></div> <div>activerecord-5.0.2/lib/active_record/callbacks.rb如下</div> <div><br></div> <div class=ever-code><pre><code>def destroy
  @_destroy_callback_already_called ||= false
  return if @_destroy_callback_already_called
  @_destroy_callback_already_called = true
  _run_destroy_callbacks { super }
rescue RecordNotDestroyed =&gt; e
  @_association_destroy_exception = e
  false
ensure
  @_destroy_callback_already_called = false
end</code></pre></div> <div><br></div> <div><br></div> <div>activerecord-5.0.2/lib/active_record/persistence.rb如下</div> <div><br></div> <div class=ever-code><pre><code>def destroy
  raise ReadOnlyRecord, "#{self.class} is marked as readonly" if readonly?
  destroy_associations
  self.class.connection.add_transaction_record(self)
  destroy_row if persisted?
  @destroyed = true
  freeze
end</code></pre></div> <div><br></div> <div><br></div> <div>这个include的顺序就在Base中</div> <div><br></div> <div class=ever-code><pre><code>#activerecord-5.0.2/lib/active_record/base.rb
module ActiveRecord
  class Base
    include Persistence
    include Callbacks
    include Transactions
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>完整调用栈如下（但实际上这个例子没自定义callback）</div> <div><br></div> <div><a href="/images/d40bd3/fbace5.html" target=_blank><img src="/images/d40bd3/5e8c01.png" alt="instance_destroy.html"></a></div> <div><br></div> <div>因此，在整个transaction中，任何关联或callback报错，都会导致删除失败</div> <div><br></div> <div>顺提，类方法destroy_all，它先查出（如果还没预加载），然后再给每个对象调destroy。有趣的是，这个跟delete的“相反”，是类方法调实例方法</div> <div><br></div> <div class=ever-code><pre><code># Destroys the records by instantiating each
# record and calling its {#destroy}[rdoc-ref:Persistence#destroy] method.
# Each object's callbacks are executed (including &lt;tt&gt;:dependent&lt;/tt&gt; association options).
# Returns the collection of objects that were destroyed; each will be frozen, to
# reflect that no changes should be made (since they can't be persisted).
#
# Note: Instantiation, callback execution, and deletion of each
# record can be time consuming when you're removing many records at
# once. It generates at least one SQL +DELETE+ query per record (or
# possibly more, to enforce your callbacks). If you want to delete many
# rows quickly, without concern for their associations or callbacks, use
# #delete_all instead.
#
# ==== Examples
#
#   Person.where(age: 0..18).destroy_all
def destroy_all(conditions = nil)
  if conditions
    ActiveSupport::Deprecation.warn(&lt;&lt;-MESSAGE.squish)
      Passing conditions to destroy_all is deprecated and will be removed in Rails 5.1.
      To achieve the same use where(conditions).destroy_all.
    MESSAGE
    where(conditions).destroy_all
  else
    records.each(&amp;:destroy).tap { reset }
  end
end</code></pre></div> <div><br></div></span> </div> </article> </section> <footer> </footer> </div> <script src="/javascripts/bundle-853f63ec.js"></script> </body> </html>