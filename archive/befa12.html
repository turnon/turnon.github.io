<!doctype html> <html> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="chrome=1"> <title>Zp Yuan *_path与*_url的由来</title> <link href="/bundle-1857e13f.css" rel=stylesheet /> <meta name=viewport content="width=device-width"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head> <body> <div class=wrapper> <header> <ul> <li class=current><a href="/index.html"><strong>笔记</strong></a></li> <li><a href="/statistics.html"><strong>统计</strong></a></li> <li><a href="/about.html"><strong>关于</strong></a></li> </ul> <div class=tags> <ol> <li> <a class=post-tag href="/index.html?tag=ruby"> <span>ruby</span> <span>57</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rails"> <span>rails</span> <span>27</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=metaprogramming"> <span>metaprogramming</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=versus"> <span>versus</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=sinatra"> <span>sinatra</span> <span>7</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=test"> <span>test</span> <span>5</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rack"> <span>rack</span> <span>4</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=minitest"> <span>minitest</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=debug"> <span>debug</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=concurrency"> <span>concurrency</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=pattern"> <span>pattern</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=javascript"> <span>javascript</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jekyll"> <span>jekyll</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=middleman"> <span>middleman</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=functional"> <span>functional</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=tilt"> <span>tilt</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jquery"> <span>jquery</span> <span>1</span> </a> </li> </ol> </div> </header> <section> <article> <h1 class=post-title>*_path与*_url的由来</h1> <span class=post-date>2015-07-26</span> <a class=post-tag href="/index.html?tag=rails">rails</a> <a class=post-tag href="/index.html?tag=ruby">ruby</a> <a class=post-tag href="/index.html?tag=versus">versus</a> <div> <span><div><b id="区别">区别</b></div> <div><br></div> <div>path是相对路径，url是绝对路径</div> <div><br></div> <div>*_path are for views because ahrefs are implicitly linked to the current URL. So it'd be a waste of bytes to repeat it over and over.</div> <div><br></div> <div>In the controller, though, *_url is needed for redirect_to because the HTTP specification mandates that the Location: header in 3xx redirects is a complete URL.</div> <div><br></div> <div>model为复数的会对应到action=&gt;index, 为单数时需要传递id参数并对应到action=&gt;show</div> <div><br></div> <div>例如，如对于user而言：</div> <div><br></div> <div>users_url # =&gt; http://localhost:3000/users</div> <div>users_path # =&gt; /users</div> <div>user_url(1) # =&gt; http://localhost:3000/users/1</div> <div>user_path(1) # =&gt; /users/1</div> <div><br></div> <div class=ever-code><pre><code>url 的名字        REST方法    对应的url的表达式              对应的controller#action
----------------------------------------------------------------------------------
travels_path      GET         /travels(.:format)            travels#index
new_travel_path   GET         /travels/new(.:format)        travels#new
edit_travel_path  GET         /travels/:id/edit(.:format)   travels#edit
travel_path       GET         /travels/:id(.:format)        travels#show
travel_path       PATCH/PUT   /travels/:id(.:format)        travels#update
travel_path       POST        /travels/:id(.:format)        travels#create
travel_path       DELETE      /travels/:id(.:format)        travels#destroy</code></pre></div> <div><br></div> <div><br></div> <div>在route_set中被初始化，然后在view或controller中才能被调用。（是method）</div> <div><br></div> <div><b id="何时生成">何时生成</b></div> <div><br></div> <div>在WelcomeController的index方法中检查:welcome_index_path的source_location，得：</div> <div><br></div> <div class=ever-code><pre><code>[3] pry(#&lt;WelcomeController&gt;)&gt; method(:welcome_index_path).source_location
=&gt; ["/home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb", 283]</code></pre></div> <div><br></div> <div><br></div> <div>查看如下：</div> <div><br></div> <div class=ever-code><pre><code>def define_url_helper(mod, route, name, opts, route_key, url_strategy)
  helper = UrlHelper.create(route, opts, route_key, url_strategy)
  mod.module_eval do
    define_method(name) do |*args|
      last = args.last
      options = case last
                when Hash
                  args.pop
                when ActionController::Parameters
                  if last.permitted?
                    args.pop.to_h
                  else
                    raise ArgumentError, ActionDispatch::Routing::INSECURE_URL_PARAMETERS_MESSAGE
                  end
                end
      helper.call self, args, options
    end
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>在define_method前加入调试语句</div> <div><br></div> <div class=ever-code><pre><code>binding.pry if /welcome_index_path/ =~ name</code></pre></div> <div><br></div> <div><br></div> <div>重新rails server，结果就立即进入了pry。查看调用栈</div> <div><br></div> <div class=ever-code><pre><code>[7] pry(#&lt;Module&gt;)&gt; _bs_
=&gt; [#&lt;Binding:70310498294340 #&lt;Module:0x007fe4dfcbf3b0&gt;.block in define_url_helper /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:283&gt;,
 #&lt;Binding:70310498342680 ActionDispatch::Routing::RouteSet::NamedRouteCollection#define_url_helper /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:282&gt;,
 #&lt;Binding:70310498390220 ActionDispatch::Routing::RouteSet::NamedRouteCollection#add /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:114&gt;,
 #&lt;Binding:70310498454920 ActionDispatch::Routing::RouteSet#add_route /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:516&gt;,
 #&lt;Binding:70310498501300 ActionDispatch::Routing::Mapper#add_route /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/mapper.rb:1657&gt;,
 #&lt;Binding:70310498550160 ActionDispatch::Routing::Mapper#decomposed_match /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/mapper.rb:1628&gt;,
 #&lt;Binding:70310498607320 ActionDispatch::Routing::Mapper#block in map_match /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/mapper.rb:1927&gt;,
 #&lt;Binding:70310498704400 ActionDispatch::Routing::Mapper#map_match /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/mapper.rb:1910&gt;,
 #&lt;Binding:70310498753600 ActionDispatch::Routing::Mapper#match /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/mapper.rb:1599&gt;,
 #&lt;Binding:70310498810300 ActionDispatch::Routing::Mapper#map_method /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/mapper.rb:719&gt;,
 #&lt;Binding:70310498859480 ActionDispatch::Routing::Mapper#get /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/mapper.rb:680&gt;,
 #&lt;Binding:70310498907560 ActionDispatch::Routing::Mapper#block in &lt;top (required)&gt; /home/z/test_rails/dapo/config/routes.rb:4&gt;,
 #&lt;Binding:70310498964660 ActionDispatch::Routing::RouteSet#eval_block /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:390&gt;,
 #&lt;Binding:70310499014220 ActionDispatch::Routing::RouteSet#draw /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:372&gt;,
 #&lt;Binding:70310499094380 Object#&lt;top (required)&gt; /home/z/test_rails/dapo/config/routes.rb:1&gt;,
#...</code></pre></div> <div><br></div> <div><br></div> <div>可见源自在config/routes.rb</div> <div><br></div> <div><b id="怎样返回url">怎样返回url</b></div> <div><br></div> <div>对*_url进行trace</div> <div><br></div> <div class=ever-code><pre><code>[2] pry(#&lt;WelcomeController&gt;)&gt; binding.trace_tree{welcome_index_url}
WelcomeController#block in index (pry):2
└─WelcomeController#block (2 levels) in define_url_helper $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:286
  └─ActionDispatch::Routing::RouteSet::NamedRouteCollection::UrlHelper::OptimizedUrlHelper#call $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:171
    ├─ActionDispatch::Routing::RouteSet::NamedRouteCollection::UrlHelper::OptimizedUrlHelper#optimize_routes_generation? $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:191
    │ └─#..
    ├─WelcomeController#url_options $GemPath0/gems/actionpack-5.0.1/lib/action_controller/metal/url_for.rb:28
    │ └─#...
    ├─ActionDispatch::Routing::RouteSet::NamedRouteCollection::UrlHelper::OptimizedUrlHelper#optimized_helper $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:183
    │ └─#...
    └─ActionDispatch::Routing::RouteSet.block in &lt;class:RouteSet&gt; $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:306
      └─ActionDispatch::Http::URL.url_for $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/http/url.rb:48
        └─#...</code></pre></div> <div><br></div> <div><br></div> <div>可见使用的是OptimizedUrlHelper（未研究），最后用route_set.rb:306的block，里面调了个url_for来返回url</div> <div><br></div> <div>而*_path也类似，用的是route_set.rb:305的block，里面调了个path_for</div> <div><br></div> <div class=ever-code><pre><code>[5] pry(#&lt;WelcomeController&gt;)&gt; binding.trace_tree{welcome_index_path}
WelcomeController#block in index (pry):5
├─WelcomeController#block (2 levels) in define_url_helper $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:286
└─WelcomeController#block (2 levels) in define_url_helper $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:286
  └─ActionDispatch::Routing::RouteSet::NamedRouteCollection::UrlHelper::OptimizedUrlHelper#call $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:171
    ├─ActionDispatch::Routing::RouteSet::NamedRouteCollection::UrlHelper::OptimizedUrlHelper#optimize_routes_generation? $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:191
    │ └─#...
    ├─WelcomeController#url_options $GemPath0/gems/actionpack-5.0.1/lib/action_controller/metal/url_for.rb:28
    │ └─#...
    ├─ActionDispatch::Routing::RouteSet::NamedRouteCollection::UrlHelper::OptimizedUrlHelper#optimized_helper $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:183
    │ └─#...
    └─ActionDispatch::Routing::RouteSet.block in &lt;class:RouteSet&gt; $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/routing/route_set.rb:305
      └─ActionDispatch::Http::URL.path_for $GemPath0/gems/actionpack-5.0.1/lib/action_dispatch/http/url.rb:68</code></pre></div> <div><br></div> <div><br></div> <div>这两个block就是</div> <div><br></div> <div class=ever-code><pre><code>PATH    = -&gt;(options) { ActionDispatch::Http::URL.path_for(options) }
UNKNOWN = -&gt;(options) { ActionDispatch::Http::URL.url_for(options) }</code></pre></div> <div><br></div> <div><br></div> <div>*_url那个叫做UNKNOWN，看上去有点奇怪，搜一下哪里用到或是否有其他名字指向他</div> <div><br></div> <div class=ever-code><pre><code>$ actionpack-5.0.1 git:(master) grep UNKNOWN -rn *
lib/action_dispatch/routing/route_set.rb:115:          define_url_helper @url_helpers_module,  route, url_name,  route.defaults, name, UNKNOWN
lib/action_dispatch/routing/route_set.rb:303:      UNKNOWN = -&gt;(options) { ActionDispatch::Http::URL.url_for(options) }
lib/action_dispatch/routing/route_set.rb:685:      def url_for(options, route_name = nil, url_strategy = UNKNOWN)</code></pre></div> <div><br></div> <div><br></div> <div>唯一与config/routes.rb调用栈能联系起来的，就是ActionDispatch::Routing::RouteSet::NamedRouteCollection#add了</div> <div><br></div> <div class=ever-code><pre><code>def add(name, route)
  key       = name.to_sym
  path_name = :"#{name}_path"
  url_name  = :"#{name}_url"

  if routes.key? key
    @path_helpers_module.send :undef_method, path_name
    @url_helpers_module.send  :undef_method, url_name
  end
  routes[key] = route
  define_url_helper @path_helpers_module, route, path_name, route.defaults, name, PATH
  define_url_helper @url_helpers_module,  route, url_name,  route.defaults, name, UNKNOWN

  @path_helpers &lt;&lt; path_name
  @url_helpers &lt;&lt; url_name
end</code></pre></div> <div><br></div> <div><br></div> <div>而这里的@path_helpers_module和@url_helpers_module，可以猜到，就是会mixin到controller的匿名module</div> <div><br></div> <div class=ever-code><pre><code>[9] pry(#&lt;WelcomeController&gt;)&gt; self.class.ancestors
=&gt; [WelcomeController,
 #&lt;Module:0x007fe9e4f389c0&gt;,
 ApplicationController,
 #&lt;Module:0x007fe9e4f3ccc8&gt;,
 #&lt;Module:0x007fe9e35025d8&gt;,
 #&lt;Module:0x007fe9e3502600&gt;,
 ActionController::Base,
 Turbolinks::Redirection,
 Turbolinks::Controller,
 ActiveRecord::Railties::ControllerRuntime,
 ActionDispatch::Routing::RouteSet::MountedHelpers,
 ActionController::ParamsWrapper,
 #...
[13] pry(#&lt;WelcomeController&gt;)&gt; self.class.ancestors[4].instance_methods(false)
=&gt; [:rails_info_properties_path, :rails_info_routes_path, :rails_info_path, :rails_mailers_path, :welcome_index_path, :welcome_go_to_index_path]
[14] pry(#&lt;WelcomeController&gt;)&gt; self.class.ancestors[5].instance_methods(false)
=&gt; [:rails_info_properties_url, :rails_info_routes_url, :rails_info_url, :rails_mailers_url, :welcome_index_url, :welcome_go_to_index_url]</code></pre></div> <div><br></div> <div><br></div></span> </div> </article> </section> <footer> </footer> </div> <script src="/javascripts/bundle-853f63ec.js"></script> </body> </html>