<!doctype html> <html> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="chrome=1"> <title>Zp Yuan view与controller的调用关系</title> <link href="/bundle-1857e13f.css" rel=stylesheet /> <meta name=viewport content="width=device-width"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head> <body> <div class=wrapper> <header> <ul> <li class=current><a href="/index.html"><strong>笔记</strong></a></li> <li><a href="/statistics.html"><strong>统计</strong></a></li> <li><a href="/about.html"><strong>关于</strong></a></li> </ul> <div class=tags> <ol> <li> <a class=post-tag href="/index.html?tag=ruby"> <span>ruby</span> <span>61</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rails"> <span>rails</span> <span>31</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=metaprogramming"> <span>metaprogramming</span> <span>12</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=versus"> <span>versus</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=sinatra"> <span>sinatra</span> <span>7</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=test"> <span>test</span> <span>5</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rack"> <span>rack</span> <span>4</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=minitest"> <span>minitest</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=debug"> <span>debug</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=concurrency"> <span>concurrency</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=pattern"> <span>pattern</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=javascript"> <span>javascript</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jekyll"> <span>jekyll</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=middleman"> <span>middleman</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=functional"> <span>functional</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=tilt"> <span>tilt</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jquery"> <span>jquery</span> <span>1</span> </a> </li> </ol> </div> </header> <section> <article> <h1 class=post-title>view与controller的调用关系</h1> <span class=post-date>2017-05-02</span> <a class=post-tag href="/index.html?tag=rails">rails</a> <a class=post-tag href="/index.html?tag=ruby">ruby</a> <div> <span><div>根据Agile Web Development with Rails 5所说：</div> <div><br></div> <div>All instance variables of the controller are also available in the template.</div> <div><br></div> <div>The controller object’s  flash ,  headers ,  logger ,  params ,  request ,  response , and  session  are available as accessor methods in the view</div> <div><br></div> <div>下面具体看看它们是怎么来的</div> <div><br></div> <div><b id="view中的flash、session等方法是怎么来的">view中的flash、session等方法是怎么来的</b></div> <div><br></div> <div>首先在view中加入&lt;% binding.pry %&gt;断点，可看到flash、params等方法都是被委托到controller上的</div> <div><br></div> <div class=ever-code><pre><code>[2] pry(#&lt;#&lt;Class:0x007feb62d4aa30&gt;&gt;)&gt; method(:flash).source_location
=&gt; ["/home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionview-5.0.2/lib/action_view/helpers/controller_helper.rb", 10]</code></pre></div> <div><br></div> <div><br></div> <div>源码如下</div> <div><br></div> <div class=ever-code><pre><code>module ActionView
  module Helpers
    # This module keeps all methods and behavior in ActionView
    # that simply delegates to the controller.
    module ControllerHelper #:nodoc:
      attr_internal :controller, :request

      delegate :request_forgery_protection_token, :params, :session, :cookies, :response, :headers,
               :flash, :action_name, :controller_name, :controller_path, :to =&gt; :controller

      def assign_controller(controller)
        if @_controller = controller
          @_request = controller.request if controller.respond_to?(:request)
          @_config  = controller.config.inheritable_copy if controller.respond_to?(:config)
          @_default_form_builder = controller.default_form_builder if controller.respond_to?(:default_form_builder)
        end
      end

      def logger
        controller.logger if controller.respond_to?(:logger)
      end
    end
  end
end</code></pre></div> <div><br></div> <div><br></div> <div><b id="view是如何获取controller的">view是如何获取controller的</b></div> <div><br></div> <div>从上面源码可看到assign_controller似乎就类似于一种setter，它是何时会被调用呢？于是，在assign_controller加入断点，然后访问/products</div> <div><br></div> <div class=ever-code><pre><code>From: /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionview-5.0.2/lib/action_view/helpers/controller_helper.rb @ line 15 ActionView::Helpers::ControllerHelper#assign_controller:

    13: def assign_controller(controller)
    14:   binding.pry
 =&gt; 15:   if @_controller = controller
    16:     @_request = controller.request if controller.respond_to?(:request)
    17:     @_config  = controller.config.inheritable_copy if controller.respond_to?(:config)
    18:     @_default_form_builder = controller.default_form_builder if controller.respond_to?(:default_form_builder)
    19:   end
    20: end

[1] pry(#&lt;#&lt;Class:0x007fc8f1f069e8&gt;&gt;)&gt; _bsi_
=&gt; {0=&gt;#&lt;Binding:70250515797060 #&lt;Class:0x007fc8f1f069e8&gt;#assign_controller /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionview-5.0.2/lib/action_view/helpers/controller_helper.rb:14&gt;,
 1=&gt;#&lt;Binding:70250516430520 #&lt;Class:0x007fc8f1f069e8&gt;#initialize /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionview-5.0.2/lib/action_view/base.rb:211&gt;,
 2=&gt;#&lt;Binding:70250513919800 #&lt;Class:0x007fc8f1f069e8&gt;#initialize /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_dispatch/routing/url_for.rb:106&gt;,
 3=&gt;#&lt;Binding:70250523128860 ProductsController#view_context /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionview-5.0.2/lib/action_view/rendering.rb:72&gt;,
 4=&gt;#&lt;Binding:70250523311660 ProductsController#_render_template /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionview-5.0.2/lib/action_view/rendering.rb:98&gt;,
 5=&gt;#&lt;Binding:70250523597300 ProductsController#_render_template /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/streaming.rb:217&gt;,
 6=&gt;#&lt;Binding:70250523872240 ProductsController#render_to_body /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionview-5.0.2/lib/action_view/rendering.rb:83&gt;,
 7=&gt;#&lt;Binding:70250524267320 ProductsController#render_to_body /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/rendering.rb:52&gt;,
 8=&gt;#&lt;Binding:70250524386040 ProductsController#render_to_body /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/renderers.rb:142&gt;,
 9=&gt;#&lt;Binding:70250524727040 ProductsController#render /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/abstract_controller/rendering.rb:26&gt;,
 10=&gt;#&lt;Binding:70250525162960 ProductsController#render /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/rendering.rb:36&gt;,
 11=&gt;#&lt;Binding:70250525316880 ProductsController#block (2 levels) in render /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:44&gt;,
 12=&gt;#&lt;Binding:70250525733820 Benchmark.block in ms /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activesupport-5.0.2/lib/active_support/core_ext/benchmark.rb:12&gt;,
 13=&gt;#&lt;Binding:70250526005360 Benchmark.realtime /home/z/.rbenv/versions/2.3.3/lib/ruby/2.3.0/benchmark.rb:308&gt;,
 14=&gt;#&lt;Binding:70250526293340 Benchmark.ms /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activesupport-5.0.2/lib/active_support/core_ext/benchmark.rb:12&gt;,
 15=&gt;#&lt;Binding:70250526546800 ProductsController#block in render /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:44&gt;,
 16=&gt;#&lt;Binding:70250526978760 ProductsController#cleanup_view_runtime /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:87&gt;,
 17=&gt;#&lt;Binding:70250527139140 ProductsController#cleanup_view_runtime /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activerecord-5.0.2/lib/active_record/railties/controller_runtime.rb:25&gt;,
 18=&gt;#&lt;Binding:70250527443460 ProductsController#render /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:43&gt;,
 19=&gt;#&lt;Binding:70250527818180 ProductsController#default_render /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/implicit_render.rb:36&gt;,
 20=&gt;#&lt;Binding:70250528143220 ProductsController#block in send_action /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/basic_implicit_render.rb:4&gt;,
 21=&gt;#&lt;Binding:70250528465280 ProductsController#send_action /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/basic_implicit_render.rb:4&gt;,
 22=&gt;#&lt;Binding:70250528827020 ProductsController#process_action /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/abstract_controller/base.rb:188&gt;,
 23=&gt;#&lt;Binding:70250529237440 ProductsController#process_action /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/rendering.rb:30&gt;,
 24=&gt;#&lt;Binding:70250529377280 ProductsController#block in process_action /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/abstract_controller/callbacks.rb:20&gt;,
 25=&gt;#&lt;Binding:70250529649300 ActiveSupport::Callbacks::Filters::End#call /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activesupport-5.0.2/lib/active_support/callbacks.rb:126&gt;,
 26=&gt;#&lt;Binding:70250530017880 ActiveSupport::Callbacks::CallbackChain#block (2 levels) in compile /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activesupport-5.0.2/lib/active_support/callbacks.rb:506&gt;,
 27=&gt;#&lt;Binding:70250530145300 ActiveSupport::Callbacks::CallbackSequence#call /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activesupport-5.0.2/lib/active_support/callbacks.rb:455&gt;,
 28=&gt;#&lt;Binding:70250530486720 ProductsController#__run_callbacks__ /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activesupport-5.0.2/lib/active_support/callbacks.rb:101&gt;,
 29=&gt;#&lt;Binding:70250528846540 ProductsController#_run_process_action_callbacks /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activesupport-5.0.2/lib/active_support/callbacks.rb:750&gt;,
 30=&gt;#&lt;Binding:70250530706720 ProductsController#run_callbacks /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activesupport-5.0.2/lib/active_support/callbacks.rb:90&gt;,
 31=&gt;#&lt;Binding:70250530360700 ProductsController#process_action /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/abstract_controller/callbacks.rb:19&gt;,
 32=&gt;#&lt;Binding:70250530031620 ProductsController#process_action /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/rescue.rb:20&gt;,
 33=&gt;#&lt;Binding:70250529656440 ProductsController#block in process_action /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:32&gt;,
 34=&gt;#&lt;Binding:70250529412960 ActiveSupport::Notifications.block in instrument /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activesupport-5.0.2/lib/active_support/notifications.rb:164&gt;,
 35=&gt;#&lt;Binding:70250529196080 ActiveSupport::Notifications::Instrumenter#instrument /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activesupport-5.0.2/lib/active_support/notifications/instrumenter.rb:21&gt;,
 36=&gt;#&lt;Binding:70250528716060 ActiveSupport::Notifications.instrument /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activesupport-5.0.2/lib/active_support/notifications.rb:164&gt;,
 37=&gt;#&lt;Binding:70250528347380 ProductsController#process_action /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:30&gt;,
 38=&gt;#&lt;Binding:70250528010780 ProductsController#process_action /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/params_wrapper.rb:248&gt;,
 39=&gt;#&lt;Binding:70250527626540 ProductsController#process_action /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/activerecord-5.0.2/lib/active_record/railties/controller_runtime.rb:18&gt;,
 40=&gt;#&lt;Binding:70250527305640 ProductsController#process /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/abstract_controller/base.rb:126&gt;,
 41=&gt;#&lt;Binding:70250527025880 ProductsController#process /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionview-5.0.2/lib/action_view/rendering.rb:30&gt;,
 42=&gt;#&lt;Binding:70250526688700 ProductsController#dispatch /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal.rb:190&gt;,
 43=&gt;#&lt;Binding:70250526391200 ProductsController.dispatch /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal.rb:262&gt;,</code></pre></div> <div><br></div> <div><br></div> <div>可发现有actionpack-5.0.2/lib/action_controller/metal/basic_implicit_render.rb</div> <div><br></div> <div class=ever-code><pre><code>module ActionController
  module BasicImplicitRender
    def send_action(method, *args)
      super.tap { default_render unless performed? }
    end

    def default_render(*args)
      head :no_content
    end
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>搜索BasicImplicitRender，可见implicit_render.rb中有include它</div> <div><br></div> <div class=ever-code><pre><code>$ gems git:(master) grep BasicImplicitRender -rn a*
actionpack-5.0.2/lib/action_controller.rb:31:    autoload :BasicImplicitRender
actionpack-5.0.2/lib/action_controller/api.rb:119:      BasicImplicitRender,
actionpack-5.0.2/lib/action_controller/metal/basic_implicit_render.rb:2:  module BasicImplicitRender # :nodoc:
actionpack-5.0.2/lib/action_controller/metal/implicit_render.rb:32:    include BasicImplicitRender</code></pre></div> <div><br></div> <div><br></div> <div>ImplicitRender部分源码如下</div> <div><br></div> <div class=ever-code><pre><code>module ImplicitRender

  include BasicImplicitRender

  def default_render(*args)
    if template_exists?(action_name.to_s, _prefixes, variants: request.variant)
      render(*args)
    elsif any_templates?(action_name.to_s, _prefixes)
      message = "#{self.class.name}\##{action_name} is missing a template " \
        "for this request format and variant.\n" \
        "\nrequest.formats: #{request.formats.map(&amp;:to_s).inspect}" \
        "\nrequest.variant: #{request.variant.inspect}"

      raise ActionController::UnknownFormat, message
    elsif interactive_browser_request?
      message = "#{self.class.name}\##{action_name} is missing a template " \
        "for this request format and variant.\n\n" \
        "request.formats: #{request.formats.map(&amp;:to_s).inspect}\n" \
        "request.variant: #{request.variant.inspect}\n\n" \
        "NOTE! For XHR/Ajax or API requests, this action would normally " \
        "respond with 204 No Content: an empty white screen. Since you're " \
        "loading it in a web browser, we assume that you expected to " \
        "actually render a template, not nothing, so we're showing an " \
        "error to be extra-clear. If you expect 204 No Content, carry on. " \
        "That's what you'll get from an XHR or API request. Give it a shot."

      raise ActionController::UnknownFormat, message
    else
      logger.info "No template found for #{self.class.name}\##{action_name}, rendering head :no_content" if logger
      super
    end
  end

  # ...

end</code></pre></div> <div><br></div> <div><br></div> <div>而ImplicitRender则在Base中被include</div> <div><br></div> <div class=ever-code><pre><code>$ gems git:(master) grep ImplicitRender -rn a*
actionpack-5.0.2/lib/action_controller.rb:31:    autoload :BasicImplicitRender
actionpack-5.0.2/lib/action_controller.rb:32:    autoload :ImplicitRender
actionpack-5.0.2/lib/action_controller/api.rb:119:      BasicImplicitRender,
actionpack-5.0.2/lib/action_controller/base.rb:218:      ImplicitRender,
actionpack-5.0.2/lib/action_controller/metal/basic_implicit_render.rb:2:  module BasicImplicitRender # :nodoc:
actionpack-5.0.2/lib/action_controller/metal/implicit_render.rb:29:  module ImplicitRender
actionpack-5.0.2/lib/action_controller/metal/implicit_render.rb:32:    include BasicImplicitRender</code></pre></div> <div><br></div> <div><br></div> <div>至此，整理一下，send_action是BasicImplicitRender才有的，但default_render是ImplicitRender的优先（只有在“No template found”是才super，去调include的BasicImplicitRender的default_render）</div> <div><br></div> <div>而default_render是只在performed?为false时才会做</div> <div><br></div> <div>这就是Agile Web Development with Rails 5中所谓的：</div> <div><br></div> <div>Because the controller must respond exactly once, it checks to see whether a response has been generated just before it finishes handling a request. If not, the controller looks for a template named after the controller and action and automatically renders it. This is the most common way that rendering takes place. You may have noticed that in most of the actions in our shopping cart tutorial we never explicitly rendered anything. Instead, our action methods set up the context for the view and return. The controller notices that no rendering has taken place and automatically invokes the appropriate template</div> <div><br></div> <div>检查一下哪些module有重载render方法</div> <div><br></div> <div class=ever-code><pre><code>[2] pry(#&lt;#&lt;Class:0x007fc8f1f069e8&gt;&gt;)&gt; _bsi_.select{|i, bi| bi.frame_env =~ /render/}
=&gt; {4=&gt;#&lt;Binding:70250147973180 ProductsController#_render_template /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionview-5.0.2/lib/action_view/rendering.rb:98&gt;,
 5=&gt;#&lt;Binding:70250147700480 ProductsController#_render_template /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/streaming.rb:217&gt;,
 6=&gt;#&lt;Binding:70250147444120 ProductsController#render_to_body /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionview-5.0.2/lib/action_view/rendering.rb:83&gt;,
 7=&gt;#&lt;Binding:70250147166220 ProductsController#render_to_body /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/rendering.rb:52&gt;,
 8=&gt;#&lt;Binding:70250146902260 ProductsController#render_to_body /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/renderers.rb:142&gt;,
 9=&gt;#&lt;Binding:70250146642820 ProductsController#render /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/abstract_controller/rendering.rb:26&gt;,
 10=&gt;#&lt;Binding:70250146383760 ProductsController#render /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/rendering.rb:36&gt;,
 11=&gt;#&lt;Binding:70250146058920 ProductsController#block (2 levels) in render /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:44&gt;,
 15=&gt;#&lt;Binding:70250144916680 ProductsController#block in render /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:44&gt;,
 18=&gt;#&lt;Binding:70250144030980 ProductsController#render /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb:43&gt;,
 19=&gt;#&lt;Binding:70250143729220 ProductsController#default_render /home/z/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/actionpack-5.0.2/lib/action_controller/metal/implicit_render.rb:36&gt;}</code></pre></div> <div><br></div> <div><br></div> <div>大概就是actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb，actionpack-5.0.2/lib/action_controller/metal/rendering.rb，actionpack-5.0.2/lib/abstract_controller/rendering.rb。如无意外就是mixin然后super。</div> <div><br></div> <div>actionpack-5.0.2/lib/action_controller/metal/instrumentation.rb如下，很直接地就用了Benchmark来计时，没有通过ActiveSupport::Notifications.instrument来调什么hook</div> <div><br></div> <div class=ever-code><pre><code>def render(*args)
  render_output = nil
  self.view_runtime = cleanup_view_runtime do
    Benchmark.ms { render_output = super }
  end
  render_output
end</code></pre></div> <div><br></div> <div><br></div> <div>actionpack-5.0.2/lib/action_controller/metal/rendering.rb如下，用于检查下有否显式地二次调用render</div> <div><br></div> <div class=ever-code><pre><code>def render(*args) #:nodoc:
  raise ::AbstractController::DoubleRenderError if self.response_body
  super
end</code></pre></div> <div><br></div> <div><br></div> <div>actionpack-5.0.2/lib/abstract_controller/rendering.rb如下，真正地生成响应体，就是在这里了</div> <div><br></div> <div class=ever-code><pre><code>def render(*args, &amp;block)
  options = _normalize_render(*args, &amp;block)
  rendered_body = render_to_body(options)
  if options[:html]
    _set_html_content_type
  else
    _set_rendered_content_type rendered_format
  end
  self.response_body = rendered_body
end</code></pre></div> <div><br></div> <div><br></div> <div><b id="render干什么">render干什么</b></div> <div><br></div> <div>上面的分析仅仅是根据字面编程来猜测，而且似乎跑偏，但可进一步猜测是controller调用render，然后render会生成view，并将当前controller赋给view，然后把view渲染成字符串后，塞到响应体中。</div> <div><br></div> <div>下面来看看具体过程，这次直接跟踪render_to_body</div> <div><br></div> <div class=ever-code><pre><code># actionpack-5.0.2/lib/abstract_controller/rendering.rb
def render(*args, &amp;block)
  options = _normalize_render(*args, &amp;block)
  #binding.pry
  rendered_body = binding.trace_tree(html: true, tmp: ['rails', "render_#{options[:template]}.html"]) do
    render_to_body(options)
  end
  if options[:html]
    _set_html_content_type
  else
    _set_rendered_content_type rendered_format
  end
  self.response_body = rendered_body
end</code></pre></div> <div><br></div> <div><br></div> <div>然后访问/products/1。跑的比较慢，生成的文件也很大，完整调用栈如下（注意，rendering.rb因为加入了三行调试语句，所以有关此文件的trace的结果，下半部分会往下偏移三行）</div> <div><br></div> <div> <a href="/images/31b699/a32235.html" target=_blank><img src="/images/31b699/681b2b.png" alt="render_show.html"></a><br> </div> <div><br></div> <div>还是从assign_controller查起，可看到controller被赋给了一个匿名类所生成的对象</div> <div><br></div> <div><a href="/images/31b699/50e19f.png" target=_blank><img src="/images/31b699/50e19f.png" type="image/png" style="height: auto;"></a></div> <div><br></div> <div>查源码，可知这里new的就是view对象，它来自动态生成的ActionView::Base子类</div> <div><br></div> <div class=ever-code><pre><code>module ClassMethods
  def view_context_class
    @view_context_class ||= begin
      supports_path = supports_path?
      routes  = respond_to?(:_routes)  &amp;&amp; _routes
      helpers = respond_to?(:_helpers) &amp;&amp; _helpers

      Class.new(ActionView::Base) do
        if routes
          include routes.url_helpers(supports_path)
          include routes.mounted_helpers
        end

        if helpers
          include helpers
        end
      end
    end
  end
end

attr_internal_writer :view_context_class

def view_context_class
  @_view_context_class ||= self.class.view_context_class
end

# An instance of a view class. The default view class is ActionView::Base.
#
# The view class must have the following methods:
# View.new[lookup_context, assigns, controller]
#   Create a new ActionView instance for a controller and we can also pass the arguments.
# View#render(option)
#   Returns String with the rendered template
#
# Override this method in a module to change the default behavior.
def view_context
  view_context_class.new(view_renderer, view_assigns, self)
end</code></pre></div> <div><br></div> <div><br></div> <div>而且，从注释也可看出，view接下来会被调用render来渲染出响应体</div> <div><br></div> <div>于是，再往上推导一下，大概流程就是如下（不过这里又说是用renderer来做render）</div> <div><br></div> <div><a href="/images/31b699/de83bd.png" target=_blank><img src="/images/31b699/de83bd.png" type="image/png" style="height: auto;"></a></div> <div><br></div> <div>另外，从view_context方法所使用的view_assigns如下，它其实就是controller的实例变量，只是简单地从controller复制到view，待会应该是会用到instance_variable_set的</div> <div><br></div> <div class=ever-code><pre><code># actionpack-5.0.2/lib/abstract_controller/rendering.rb
DEFAULT_PROTECTED_INSTANCE_VARIABLES = Set.new %i(
  @_action_name @_response_body @_formats @_prefixes
)

# This method should return a hash with assigns.
# You can overwrite this configuration per controller.
# :api: public
def view_assigns
  protected_vars = _protected_ivars
  variables      = instance_variables

  variables.reject! { |s| protected_vars.include? s }
  variables.each_with_object({}) { |name, hash|
    hash[name.slice(1, name.length)] = instance_variable_get(name)
  }
end</code></pre></div> <div><br></div> <div><br></div> <div>确实，在assign_controller之前，会assign这些变量</div> <div><br></div> <div><a href="/images/31b699/b7ce68.png" target=_blank><img src="/images/31b699/b7ce68.png" type="image/png" style="height: auto;"></a></div> <div><br></div> <div>源码如下</div> <div><br></div> <div class=ever-code><pre><code># actionview-5.0.2/lib/action_view/base.rb
def initialize(context = nil, assigns = {}, controller = nil, formats = nil) #:nodoc:
  @_config = ActiveSupport::InheritableOptions.new

  if context.is_a?(ActionView::Renderer)
    @view_renderer = context
  else
    lookup_context = context.is_a?(ActionView::LookupContext) ?
      context : ActionView::LookupContext.new(context)
    lookup_context.formats  = formats if formats
    lookup_context.prefixes = controller._prefixes if controller
    @view_renderer = ActionView::Renderer.new(lookup_context)
  end

  assign(assigns)
  assign_controller(controller)
  _prepare_context
end</code></pre></div> <div><br></div> <div><br></div> <div>直接加入断点的话，会看到有product这个变量（当然，set时候会前面带上@）</div> <div><br></div> <div class=ever-code><pre><code>From: /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/base.rb @ line 199 ActionView::Base#initialize:

    197: def initialize(context = nil, assigns = {}, controller = nil, formats = nil) #:nodoc:
    198:   binding.pry
 =&gt; 199:   @_config = ActiveSupport::InheritableOptions.new
    200:
    201:   if context.is_a?(ActionView::Renderer)
    202:     @view_renderer = context
    203:   else
    204:     lookup_context = context.is_a?(ActionView::LookupContext) ?
    205:       context : ActionView::LookupContext.new(context)
    206:     lookup_context.formats  = formats if formats
    207:     lookup_context.prefixes = controller._prefixes if controller
    208:     @view_renderer = ActionView::Renderer.new(lookup_context)
    209:   end
    210:
    211:   assign(assigns)
    212:   assign_controller(controller)
    213:   _prepare_context
    214: end

[1] pry(#&lt;#&lt;Class:0x007ffa54853170&gt;&gt;)&gt; assigns.keys
=&gt; ["marked_for_same_origin_verification", "product"]</code></pre></div> <div><br></div> <div><br></div> <div><b id="小结">小结</b></div> <div><br></div> <div>至此，基本可以知道，flash、session等方法，是委托controller而来的，而controller的实例变量，是复制到view的</div></span> </div> </article> </section> <footer> </footer> </div> <script src="/javascripts/bundle-853f63ec.js"></script> </body> </html>