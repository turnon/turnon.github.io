<!doctype html> <html> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="chrome=1"> <title>Zp Yuan jquery-ujs</title> <link href="/bundle-1857e13f.css" rel=stylesheet /> <meta name=viewport content="width=device-width"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head> <body> <div class=wrapper> <header> <ul> <li class=current><a href="/index.html"><strong>笔记</strong></a></li> <li><a href="/statistics.html"><strong>统计</strong></a></li> <li><a href="/about.html"><strong>关于</strong></a></li> </ul> <div class=tags> <ol> <li> <a class=post-tag href="/index.html?tag=ruby"> <span>ruby</span> <span>51</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rails"> <span>rails</span> <span>21</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=metaprogramming"> <span>metaprogramming</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=versus"> <span>versus</span> <span>9</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=sinatra"> <span>sinatra</span> <span>7</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=test"> <span>test</span> <span>5</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rack"> <span>rack</span> <span>4</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=pattern"> <span>pattern</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=minitest"> <span>minitest</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=debug"> <span>debug</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=concurrency"> <span>concurrency</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jekyll"> <span>jekyll</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=javascript"> <span>javascript</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=middleman"> <span>middleman</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=functional"> <span>functional</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=tilt"> <span>tilt</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jquery"> <span>jquery</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=underscore"> <span>underscore</span> <span>1</span> </a> </li> </ol> </div> </header> <section> <article> <h1 class=post-title>jquery-ujs</h1> <span class=post-date>2017-03-06</span> <a class=post-tag href="/index.html?tag=javascript">javascript</a> <a class=post-tag href="/index.html?tag=jquery">jquery</a> <a class=post-tag href="/index.html?tag=rails">rails</a> <a class=post-tag href="/index.html?tag=ruby">ruby</a> <div> <span><div>根据官方介绍，Unobtrusive scripting adapter for jQuery所做的就是</div> <div><br></div> <div>1.force confirmation dialogs for various actions;</div> <div>2.make non-GET requests from hyperlinks;</div> <div>3.make forms or hyperlinks submit data asynchronously with Ajax;</div> <div>4.have submit buttons become automatically disabled on form submit to prevent double-clicking.</div> <div><br></div> <div>对于以下link_to helper</div> <div><br></div> <div class=ever-code><pre><code>&lt;%= link_to 'Destroy', article_path(article), method: :delete, data: { confirm: 'Are you sure?'  } %&gt;</code></pre></div> <div><br></div> <div><br></div> <div>它所生成的&lt;a&gt;会被监听以下click事件</div> <div><br></div> <div><a href="/images/89be4b/50e19f.png" target=_blank><img src="/images/89be4b/50e19f.png" type="image/png" style="height: auto;"></a></div> <div><br></div> <div><br></div> <div>逐个点开来看，以下这个比较像样：监听整个document的click，并筛选出rails.linkClickSelector</div> <div><br></div> <div class=ever-code><pre><code>$document.on('click.rails', rails.linkClickSelector, function(e) {
  var link = $(this), method = link.data('method'), data = link.data('params'), metaClick = e.metaKey || e.ctrlKey;
  if (!rails.allowAction(link)) return rails.stopEverything(e);

  if (!metaClick &amp;&amp; link.is(rails.linkDisableSelector)) rails.disableElement(link);

  if (rails.isRemote(link)) {
    if (metaClick &amp;&amp; (!method || method === 'GET') &amp;&amp; !data) { return true; }

    var handleRemote = rails.handleRemote(link);
    // Response from rails.handleRemote() will either be false or a deferred object promise.
    if (handleRemote === false) {
      rails.enableElement(link);
    } else {
      handleRemote.fail( function() { rails.enableElement(link); } );
    }
    return false;

  } else if (method) {
    rails.handleMethod(link);
    return false;
  }
});</code></pre></div> <div><br></div> <div><br></div> <div>其中rails.linkClickSelecto如下，使handler只作用于a[data-xxx]标签（不包括a[data-disable-xxx]）</div> <div><br></div> <div class=ever-code><pre><code>$.rails = rails = {
  // Link elements bound by jquery-ujs
  linkClickSelector: 'a[data-confirm], a[data-method], a[data-remote]:not([disabled]), a[data-disable-with], a[data-disable]',

  // Button elements bound by jquery-ujs
  buttonClickSelector: 'button[data-remote]:not([form]):not(form button), button[data-confirm]:not([form]):not(form button)',

  // Select elements bound by jquery-ujs
  inputChangeSelector: 'select[data-remote], input[data-remote], textarea[data-remote]',

  // Form elements bound by jquery-ujs
  formSubmitSelector: 'form',

  // Form input elements bound by jquery-ujs
  formInputClickSelector: 'form input[type=submit], form input[type=image], form button[type=submit], form button:not([type]), input[type=submit][form], input[type=image][form], button[type=submit][form], button[form]:not([type])',

  // Form input elements disabled during form submission
  disableSelector: 'input[data-disable-with]:enabled, button[data-disable-with]:enabled, textarea[data-disable-with]:enabled, input[data-disable]:enabled, button[data-disable]:enabled, textarea[data-disable]:enabled',

  // Form input elements re-enabled after form submission
  enableSelector: 'input[data-disable-with]:disabled, button[data-disable-with]:disabled, textarea[data-disable-with]:disabled, input[data-disable]:disabled, button[data-disable]:disabled, textarea[data-disable]:disabled',

  // Form required input elements
  requiredInputSelector: 'input[name][required]:not([disabled]), textarea[name][required]:not([disabled])',

  // Form file input elements
  fileInputSelector: 'input[name][type=file]:not([disabled])',

  // Link onClick disable selector with possible reenable after remote submission
  linkDisableSelector: 'a[data-disable-with], a[data-disable]',

  // Button onClick disable selector with possible reenable after remote submission
  buttonDisableSelector: 'button[data-remote][data-disable-with], button[data-remote][data-disable]',

  // ...
}</code></pre></div> <div><br></div> <div><br></div> <div>对于非remote（ajax）的，就使用rails.handleMethod(link)</div> <div><br></div> <div class=ever-code><pre><code>handleMethod: function(link) {
  var href = rails.href(link),
    method = link.data('method'),
    target = link.attr('target'),
    csrfToken = rails.csrfToken(),
    csrfParam = rails.csrfParam(),
    form = $('&lt;form method="post" action="' + href + '"&gt;&lt;/form&gt;'),
    metadataInput = '&lt;input name="_method" value="' + method + '" type="hidden" /&gt;';

  if (csrfParam !== undefined &amp;&amp; csrfToken !== undefined &amp;&amp; !rails.isCrossDomain(href)) {
    metadataInput += '&lt;input name="' + csrfParam + '" value="' + csrfToken + '" type="hidden" /&gt;';
  }

  if (target) { form.attr('target', target); }

  form.hide().append(metadataInput).appendTo('body');
  form.submit();
}</code></pre></div> <div><br></div> <div><br></div> <div>它基本上做的就是从&lt;a&gt;中抽取data-xxx，拼接成一个form，然后submit</div> <div><br></div> <div>因此，对于一个如下的&lt;a&gt;</div> <div><br></div> <div class=ever-code><pre><code>&lt;a data-confirm="Are you sure?" rel="nofollow" data-method="delete" href="/articles/6"&gt;Destroy&lt;/a&gt;</code></pre></div> <div><br></div> <div><br></div> <div>步入该函数，会发现它抓得各种attribute和input如下</div> <div><br></div> <div><a href="/images/89be4b/de83bd.png" target=_blank><img src="/images/89be4b/de83bd.png" type="image/png" style="height: auto;"></a></div> <div><br></div> <div><br></div> <div>拼接出的&lt;form&gt;如下</div> <div><br></div> <div><a href="/images/89be4b/b7ce68.png" target=_blank><img src="/images/89be4b/b7ce68.png" type="image/png" style="height: auto;"></a></div></span> </div> </article> </section> <footer> </footer> </div> <script src="/javascripts/bundle-853f63ec.js"></script> </body> </html>