<!doctype html> <html> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="chrome=1"> <title>Zp Yuan Functional Testing of Controllers</title> <link href="/bundle-1857e13f.css" rel=stylesheet /> <meta name=viewport content="width=device-width"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head> <body> <div class=wrapper> <header> <ul> <li class=current><a href="/index.html"><strong>笔记</strong></a></li> <li><a href="/statistics.html"><strong>统计</strong></a></li> <li><a href="/about.html"><strong>关于</strong></a></li> </ul> <div class=tags> <ol> <li> <a class=post-tag href="/index.html?tag=ruby"> <span>ruby</span> <span>57</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rails"> <span>rails</span> <span>27</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=metaprogramming"> <span>metaprogramming</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=versus"> <span>versus</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=sinatra"> <span>sinatra</span> <span>7</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=test"> <span>test</span> <span>5</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rack"> <span>rack</span> <span>4</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=minitest"> <span>minitest</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=debug"> <span>debug</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=concurrency"> <span>concurrency</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=pattern"> <span>pattern</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=javascript"> <span>javascript</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jekyll"> <span>jekyll</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=middleman"> <span>middleman</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=functional"> <span>functional</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=tilt"> <span>tilt</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jquery"> <span>jquery</span> <span>1</span> </a> </li> </ol> </div> </header> <section> <article> <h1 class=post-title>Functional Testing of Controllers</h1> <span class=post-date>2017-04-09</span> <a class=post-tag href="/index.html?tag=rails">rails</a> <a class=post-tag href="/index.html?tag=ruby">ruby</a> <a class=post-tag href="/index.html?tag=test">test</a> <div> <span><div>对于controller的功能性测试，可以这样写（摘自IntegrationTest里的注释）</div> <div><br></div> <div class=ever-code><pre><code>class UserFlowsTest &lt; ActionDispatch::IntegrationTest
  test "login and browse site" do
    # login via https
    https!
    get "/login"
    assert_response :success

    post "/login", params: { username: users(:david).username, password: users(:david).password }
    follow_redirect!
    assert_equal '/welcome', path
    assert_equal 'Welcome david!', flash[:notice]

    https!(false)
    get "/articles/all"
    assert_response :success
    assert_select 'h1', 'Articles'
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>这里的assert_response是这样定义的，它只是简单地将assertion转发给@response</div> <div><br></div> <div class=ever-code><pre><code>module ActionDispatch
  module Assertions
    # A small suite of assertions that test responses from \Rails applications.
    module ResponseAssertions
      RESPONSE_PREDICATES = { # :nodoc:
        success:  :successful?,
        missing:  :not_found?,
        redirect: :redirection?,
        error:    :server_error?,
      }

      # Asserts that the response is one of the following types:
      #
      # * &lt;tt&gt;:success&lt;/tt&gt;   - Status code was in the 200-299 range
      # * &lt;tt&gt;:redirect&lt;/tt&gt;  - Status code was in the 300-399 range
      # * &lt;tt&gt;:missing&lt;/tt&gt;   - Status code was 404
      # * &lt;tt&gt;:error&lt;/tt&gt;     - Status code was in the 500-599 range
      #
      # You can also pass an explicit status number like &lt;tt&gt;assert_response(501)&lt;/tt&gt;
      # or its symbolic equivalent &lt;tt&gt;assert_response(:not_implemented)&lt;/tt&gt;.
      # See Rack::Utils::SYMBOL_TO_STATUS_CODE for a full list.
      #
      #   # Asserts that the response was a redirection
      #   assert_response :redirect
      #
      #   # Asserts that the response code was status code 401 (unauthorized)
      #   assert_response 401
      def assert_response(type, message = nil)
        message ||= generate_response_message(type)

        if RESPONSE_PREDICATES.keys.include?(type)
          assert @response.send(RESPONSE_PREDICATES[type]), message
        else
          assert_equal AssertionResponse.new(type).code, @response.response_code, message
        end
      end</code></pre></div> <div><br></div> <div><br></div> <div>之所以能对response做assert，是因为ActionDispatch::IntegrationTest完成一轮请求响应后，有保存@response</div> <div><br></div> <div class=ever-code><pre><code>def process(method, path, params: nil, headers: nil, env: nil, xhr: false, as: nil)

  # ......

  session = Rack::Test::Session.new(_mock_session)

  session.request(build_full_uri(path, request_env), request_env)

  @request_count += 1
  @request = ActionDispatch::Request.new(session.last_request.env)
  response = _mock_session.last_response
  @response = ActionDispatch::TestResponse.from_response(response)
  @response.request = @request
  @html_document = nil
  @url_options = nil

  @controller = @request.controller_instance

  response.status
end</code></pre></div> <div><br></div> <div><br></div> <div>这里包装response的ActionDispatch::TestResponse其实只是简单包装，与RESPONSE_PREDICATES无关</div> <div><br></div> <div class=ever-code><pre><code>module ActionDispatch

  class TestResponse &lt; Response
    def self.from_response(response)
      new response.status, response.headers, response.body
    end

    def initialize(*) # :nodoc:
      super
      @response_parser = RequestEncoder.parser(content_type)
    end

    # Was the response successful?
    alias_method :success?, :successful?

    # Was the URL not found?
    alias_method :missing?, :not_found?

    # Was there a server-side error?
    alias_method :error?, :server_error?

    def parsed_body
      @parsed_body ||= @response_parser.call(body)
    end
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>RESPONSE_PREDICATES所用的方法是Rack本来就提供的</div> <div><br></div> <div class=ever-code><pre><code>module Rack
  class Response
    module Helpers
      def invalid?;             status &lt; 100 || status &gt;= 600;        end

      def informational?;       status &gt;= 100 &amp;&amp; status &lt; 200;        end
      def successful?;          status &gt;= 200 &amp;&amp; status &lt; 300;        end
      def redirection?;         status &gt;= 300 &amp;&amp; status &lt; 400;        end
      def client_error?;        status &gt;= 400 &amp;&amp; status &lt; 500;        end
      def server_error?;        status &gt;= 500 &amp;&amp; status &lt; 600;        end

      def ok?;                  status == 200;                        end
      def created?;             status == 201;                        end
      def accepted?;            status == 202;                        end
      def no_content?;          status == 204;                        end
      def moved_permanently?;   status == 301;                        end
      def bad_request?;         status == 400;                        end
      def unauthorized?;        status == 401;                        end
      def forbidden?;           status == 403;                        end
      def not_found?;           status == 404;                        end
      def method_not_allowed?;  status == 405;                        end
      def precondition_failed?; status == 412;                        end
      def unprocessable?;       status == 422;                        end

      def redirect?;            [301, 302, 303, 307, 308].include? status; end
    end

  include Helpers

  end
end</code></pre></div> <div><br></div> <div><br></div> <div>至于assert_select，使用的是nokogiri来抽取dom来检验</div> <div><br></div> <div>如果进行trace的话</div> <div><br></div> <div class=ever-code><pre><code>binding.trace_tree(html: true, tmp: ['rails', 'assert_select.html']) do
  assert_select '.price', /\$[,\d]+\.\d\d/
end</code></pre></div> <div><br></div> <div><br></div> <div>可得调用栈如下</div> <div><br></div> <div><a href="/images/742bff/cb1f3b.html" target=_blank><img src="/images/742bff/6b5517.png" alt="assert_select.html"></a></div> <div><br></div> <div>大概流程如下</div> <div><br></div> <div><a href="/images/742bff/50e19f.png" target=_blank><img src="/images/742bff/50e19f.png" type="image/png" style="height: auto;"></a></div> <div><br></div> <div>assert_select会根据所传参数来建立一个HTMLSelector，这个HTMLSelector所要select的页面是document_root_element</div> <div><br></div> <div class=ever-code><pre><code>def assert_select(*args, &amp;block)
  @selected ||= nil

  selector = HTMLSelector.new(args, @selected) { nodeset document_root_element }

  if selector.selecting_no_body?
    assert true
    return
  end

  selector.select.tap do |matches|
    assert_size_match!(matches.size, selector.tests,
      selector.css_selector, selector.message)

    nest_selection(matches, &amp;block) if block_given? &amp;&amp; !matches.empty?
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>这个document_root_element实际上也是从response的body取出html，并用nokogiri包装（解析）出的root元素</div> <div><br></div> <div class=ever-code><pre><code>#actionpack-5.0.2/lib/action_dispatch/testing/integration.rb
def document_root_element
  html_document.root
end</code></pre></div> <div><br></div> <div><br></div> <div>html_document如下</div> <div><br></div> <div class=ever-code><pre><code>module ActionDispatch
  module Assertions
    autoload :ResponseAssertions, 'action_dispatch/testing/assertions/response'
    autoload :RoutingAssertions, 'action_dispatch/testing/assertions/routing'

    extend ActiveSupport::Concern

    include ResponseAssertions
    include RoutingAssertions
    include Rails::Dom::Testing::Assertions

    def html_document
      @html_document ||= if @response.content_type.to_s =~ /xml\z/
        Nokogiri::XML::Document.parse(@response.body)
      else
        Nokogiri::HTML::Document.parse(@response.body)
      end
    end
  end
end</code></pre></div> <div><br></div></span> </div> </article> </section> <footer> </footer> </div> <script src="/javascripts/bundle-853f63ec.js"></script> </body> </html>