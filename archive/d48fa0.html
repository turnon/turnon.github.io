<!doctype html> <html> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="chrome=1"> <title>Zp Yuan 如何在middleman的extension中访问config.rb里定义的set/config</title> <link href="/bundle-1857e13f.css" rel=stylesheet /> <meta name=viewport content="width=device-width"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head> <body> <div class=wrapper> <header> <ul> <li class=current><a href="/index.html"><strong>笔记</strong></a></li> <li><a href="/statistics.html"><strong>统计</strong></a></li> <li><a href="/about.html"><strong>关于</strong></a></li> </ul> <div class=tags> <ol> <li> <a class=post-tag href="/index.html?tag=ruby"> <span>ruby</span> <span>48</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rails"> <span>rails</span> <span>16</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=metaprogramming"> <span>metaprogramming</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=versus"> <span>versus</span> <span>10</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=javascript"> <span>javascript</span> <span>8</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=sinatra"> <span>sinatra</span> <span>7</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=pattern"> <span>pattern</span> <span>6</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rack"> <span>rack</span> <span>4</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=minitest"> <span>minitest</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=underscore"> <span>underscore</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=debug"> <span>debug</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=concurrency"> <span>concurrency</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jekyll"> <span>jekyll</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=test"> <span>test</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=middleman"> <span>middleman</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=functional"> <span>functional</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=tilt"> <span>tilt</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=java"> <span>java</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rubinius"> <span>rubinius</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jquery"> <span>jquery</span> <span>1</span> </a> </li> </ol> </div> </header> <section> <article> <h1 class=post-title>如何在middleman的extension中访问config.rb里定义的set/config</h1> <span class=post-date>2016-12-22</span> <a class=post-tag href="/index.html?tag=middleman">middleman</a> <a class=post-tag href="/index.html?tag=ruby">ruby</a> <div> <span><div>为了在build时能方便切换blog文章的来源目录，打算在config.rb中作如下定义</div> <div><br></div> <div class=ever-code><pre><code>set :evernotes_dir, 'evernotes_0'</code></pre></div> <div><br></div> <div><br></div> <div>然后在extension的before_build方法中按官方文档所教的“以config[:xxx]命令获取”，但不行。细看一下，发现文档说的只是在template和helper中使用，至于在extension如何访问，则没说。</div> <div><br></div> <div>试着在before_build中用pry查看下有什么看上去像config的方法：</div> <div><br></div> <div class=ever-code><pre><code>[8] pry(#&lt;EverMid&gt;)&gt; methods.sort.join ', '
=&gt; "!, !=, !~, &lt;=&gt;, ==, ===, =~, Contract, __binding__, __id__, __pry__, __send__, add_exposed_to_context, after_extension_activated, app, before_build, blank?, class, class_eval, clone, deep_dup, define_singleton_method, display, dup, duplicable?, enum_for, eql?, equal?, extend, freeze, frozen?, functype, hash, html_safe?, inspect, instance_eval, instance_exec, instance_of?, instance_variable_defined?, instance_variable_get, instance_variable_set, instance_variables, is_a?, is_haml?, itself, kind_of?, logger, method, methods, nil?, object_id, options, presence, present?, pretty_inspect, pretty_print, pretty_print_cycle, pretty_print_inspect, pretty_print_instance_variables, private_methods, protected_methods, pry, psych_to_yaml, public_method, public_methods, public_send, remove_instance_variable, respond_to?, send, singleton_class, singleton_method, singleton_methods, taint, tainted?, tap, to_enum, to_json, to_param, to_query, to_s, to_yaml, to_yaml_properties, trust, try, try!, untaint, untrust, untrusted?"</code></pre></div> <div><br></div> <div><br></div> <div>没有，再试看有什么实例变量：</div> <div><br></div> <div class=ever-code><pre><code>[10] pry(#&lt;EverMid&gt;)&gt; instance_variables
=&gt; [:@_helpers, :@app, :@options]
[11] pry(#&lt;EverMid&gt;)&gt; @options
=&gt; #&lt;Middleman::Configuration::ConfigurationManager:0xa10b1d4
 @finalized=true,
 @settings={:my_option=&gt;#&lt;Middleman::Configuration::ConfigSetting:0xa10b044 @default="default", @description="An example option", @key=:my_option, @options={}, @value_set=false&gt;}&gt;
[12] pry(#&lt;EverMid&gt;)&gt; @app
=&gt; #&lt;Middleman::Application:0x85723560&gt;</code></pre></div> <div><br></div> <div><br></div> <div>也没看出什么像样的东西。</div> <div><br></div> <div>考虑到在build的过程中肯定会在某一级调用读取config.rb，因此，想用binding_of_caller这个gem来探测调用栈中哪里有config、evernotes_dir、evernotes_dir这样的字眼。（为了方便，用enhance过的binding_of_callers）</div> <div><br></div> <div class=ever-code><pre><code>[14] pry(#&lt;EverMid&gt;)&gt; bs = binding.of_callers!
=&gt; [#&lt;Binding:86248360 EverMid#__pry__ (pry):7&gt;,
 #&lt;Binding:86210310 Pry#evaluate_ruby /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/pry_instance.rb:355&gt;,
 #&lt;Binding:86204680 Pry#handle_line /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/pry_instance.rb:355&gt;,
 #&lt;Binding:86167060 Pry#block (2 levels) in eval /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/pry_instance.rb:323&gt;,
 #&lt;Binding:86121230 Pry#block in eval /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/pry_instance.rb:243&gt;,
 #&lt;Binding:86116250 Pry#eval /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/pry_instance.rb:242&gt;,
 #&lt;Binding:86078760 Pry::REPL#block in repl /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/pry_instance.rb:242&gt;,
 #&lt;Binding:86073630 Pry::REPL#repl /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/pry_instance.rb:241&gt;,
 #&lt;Binding:86043750 Pry::REPL#block in start /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/pry_instance.rb:241&gt;,
 #&lt;Binding:86011310 Pry::InputLock#__with_ownership /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/repl.rb:77&gt;,
 #&lt;Binding:85973270 Pry::InputLock#with_ownership /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/repl.rb:67&gt;,
 #&lt;Binding:85968860 Pry::REPL#start /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/repl.rb:67&gt;,
 #&lt;Binding:85948270 Pry::REPL.start /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/repl.rb:38&gt;,
 #&lt;Binding:85943700 Pry.start /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/input_lock.rb:61&gt;,
 #&lt;Binding:85929950 EverMid#pry /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/input_lock.rb:61&gt;,
 #&lt;Binding:85892790 EverMid#before_build /home/ken/.rvm/gems/ruby-2.2.2/gems/pry-0.10.4/lib/pry/input_lock.rb:79&gt;,
 #&lt;Binding:85888300 Middleman::Application#block in bind_before_build /ho
......</code></pre></div> <div><br></div> <div><br></div> <div>很多，也很难看，直接探测实例变量：</div> <div><br></div> <div class=ever-code><pre><code>[19] pry(#&lt;EverMid&gt;)&gt; bs.map{|b| [b.klass, b.iv.select{|name| name =~ /config/}]}
=&gt; [[EverMid, {}],
......
 [Pry::REPL, {}],
 [Pry, {:@config=&gt;&lt;Pry::Config:0x4bdc76c^A local_keys=['hooks'] default=&lt;Pry::Config::Default:0x4bdc8de^A local_keys=['gist','history'] default=nil&gt;&gt;}],
 [EverMid, {}],
 [EverMid, {}],
 [Middleman::Application,
  {:@config_context=&gt;
......
       :evernotes_dir=&gt;#&lt;Middleman::Configuration::ConfigSetting:0xa10a8b0 @default="evernotes_0", @description=nil, @key=:evernotes_dir, @options={}, @value="evernotes_0", @value_set=true&gt;}&gt;}],
 [Middleman::CallbackManager, {}],</code></pre></div> <div><br></div> <div><br></div> <div>终于发现了:evernotes_dir、evernotes_0，在Middleman::Application类中。想起刚才extension中有个实例变量@app，试试</div> <div><br></div> <div class=ever-code><pre><code>[21] pry(#&lt;EverMid&gt;)&gt; @app.methods.sort.join ', '
=&gt; "!, !=, !~, &lt;=&gt;, ==, ===, =~, Contract, __binding__, __contracts_ruby_original_build?_ix0hp0bmej, __contracts_ruby_original_config_context_ix0hp0ble6bp, __contracts_ruby_original_config_ix0hp0bl8hm2, __contracts_ruby_original_development?_ix0hp0bnhrqm, __contracts_ruby_original_environment?_ix0hp0bn8qel, __contracts_ruby_original_environment_ix0hp0bnk1jp, __contracts_ruby_original_extensions_ix0hp0blctlv, __contracts_ruby_original_map_ix0hp0bnbeki, __contracts_ruby_original_mappings_ix0hp0blcpvd, __contracts_ruby_original_middleware_ix0hp0bld93n, __contracts_ruby_original_mode?_ix0hp0bmjim0, __contracts_ruby_original_production?_ix0hp0bnawq8, __contracts_ruby_original_server?_ix0hp0bmkvoo, __contracts_ruby_original_sitemap_ix0hp0blgt4w, __contracts_ruby_original_source_dir_ix0hp0bnhp6o, __id__, __send__, activate, after_build, after_configuration, after_configuration_eval, after_render, apply_cli_options, asset_path, before, before_build, before_configuration, before_extensions, before_instance_block, before_render, before_server, before_shutdown, before_sitemap, blank?, build?, callbacks_for, class, class_eval, clone, config, config_context, configure, data, deep_dup, define_setting, define_singleton_method, development?, display, dup, duplicable?, enum_for, environment, environment?, eql?, equal?, evaluate_configuration!, execute_callbacks, extend, extensions, files, freeze, frozen?, functype, generic_template_context, hash, html_safe?, ignore, image_tag, initialized, inspect, instance_eval, instance_exec, instance_of?, instance_variable_defined?, instance_variable_get, instance_variable_set, instance_variables, instrument, is_a?, is_haml?, itself, kind_of?, link_to, logger, map, mappings, method, methods, middleware, mode?, nil?, object_id, presence, present?, pretty_inspect, pretty_print, pretty_print_cycle, pretty_print_inspect, pretty_print_instance_variables, private_methods, production?, protected_methods, prune_tilt_templates!, pry, psych_to_yaml, public_method, public_methods, public_send, ready, reload, remove_instance_variable, respond_to?, rewrite_inline_urls, root, root_path, send, server?, set, shutdown!, singleton_class, singleton_method, singleton_methods, sitemap, source_dir, subscribe_to_callbacks, taint, tainted?, tap, template_context_class, to_enum, to_json, to_param, to_query, to_s, to_yaml, to_yaml_properties, trust, try, try!, untaint, untrust, untrusted?, use"
[24] pry(#&lt;EverMid&gt;)&gt; @app.config[:evernotes_dir]
=&gt; "evernotes_0"</code></pre></div> <div><br></div> <div><br></div> <div>即是，在extension里可使用app.config[:xxx]来获取config.rb的配置</div></span> </div> </article> </section> <footer> </footer> </div> <script src="/javascripts/bundle-853f63ec.js"></script> </body> </html>