<!doctype html> <html> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="chrome=1"> <title>Zp Yuan find、find_by、find_by_xx、where的区别</title> <link href="/bundle-1857e13f.css" rel=stylesheet /> <meta name=viewport content="width=device-width"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head> <body> <div class=wrapper> <header> <ul> <li class=current><a href="/index.html"><strong>笔记</strong></a></li> <li><a href="/statistics.html"><strong>统计</strong></a></li> <li><a href="/about.html"><strong>关于</strong></a></li> </ul> <div class=tags> <ol> <li> <a class=post-tag href="/index.html?tag=ruby"> <span>ruby</span> <span>51</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rails"> <span>rails</span> <span>21</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=metaprogramming"> <span>metaprogramming</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=versus"> <span>versus</span> <span>9</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=sinatra"> <span>sinatra</span> <span>7</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=test"> <span>test</span> <span>5</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rack"> <span>rack</span> <span>4</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=pattern"> <span>pattern</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=minitest"> <span>minitest</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=debug"> <span>debug</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=concurrency"> <span>concurrency</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jekyll"> <span>jekyll</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=javascript"> <span>javascript</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=middleman"> <span>middleman</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=functional"> <span>functional</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=tilt"> <span>tilt</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jquery"> <span>jquery</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=underscore"> <span>underscore</span> <span>1</span> </a> </li> </ol> </div> </header> <section> <article> <h1 class=post-title>find、find_by、find_by_xx、where的区别</h1> <span class=post-date>2015-08-13</span> <a class=post-tag href="/index.html?tag=rails">rails</a> <a class=post-tag href="/index.html?tag=ruby">ruby</a> <a class=post-tag href="/index.html?tag=versus">versus</a> <div> <span><div><b id=find>find</b></div> <div><br></div> <div>只返回一条记录（first）</div> <div><br></div> <div>只能按id查找，即是参数为数字</div> <div><br></div> <div>找不到记录会报错</div> <div><br></div> <div class=ever-code><pre><code># activerecord-5.0.2/lib/active_record/core.rb
def find(*ids) # :nodoc:
  # We don't have cache keys for this stuff yet
  return super unless ids.length == 1
  return super if block_given? ||
                  primary_key.nil? ||
                  scope_attributes? ||
                  columns_hash.include?(inheritance_column) ||
                  ids.first.kind_of?(Array)

  id  = ids.first
  if ActiveRecord::Base === id
    id = id.id
    ActiveSupport::Deprecation.warn(&lt;&lt;-MSG.squish)
      You are passing an instance of ActiveRecord::Base to `find`.
      Please pass the id of the object by calling `.id`.
    MSG
  end

  key = primary_key

  statement = cached_find_by_statement(key) { |params|
    where(key =&gt; params.bind).limit(1)
  }
  record = statement.execute([id], self, connection).first
  unless record
    raise RecordNotFound.new("Couldn't find #{name} with '#{primary_key}'=#{id}",
                             name, primary_key, id)
  end
  record
rescue RangeError
  raise RecordNotFound.new("Couldn't find #{name} with an out of range value for '#{primary_key}'",
                           name, primary_key)
end</code></pre></div> <div><br></div> <div><br></div> <div><b id=find_by>find_by</b></div> <div><br></div> <div>也只返回一条记录（first）</div> <div><br></div> <div>参数一般为hash，如{id: 99}</div> <div><br></div> <div class=ever-code><pre><code># activerecord-5.0.2/lib/active_record/core.rb
def find_by(*args) # :nodoc:
  return super if scope_attributes? || reflect_on_all_aggregations.any?

  hash = args.first

  return super if !(Hash === hash) || hash.values.any? { |v|
    v.nil? || Array === v || Hash === v || Relation === v || Base === v
  }

  # We can't cache Post.find_by(author: david) ...yet
  return super unless hash.keys.all? { |k| columns_hash.has_key?(k.to_s) }

  keys = hash.keys

  statement = cached_find_by_statement(keys) { |params|
    wheres = keys.each_with_object({}) { |param, o|
      o[param] = params.bind
    }
    where(wheres).limit(1)
  }
  begin
    statement.execute(hash.values, self, connection).first
  rescue TypeError
    raise ActiveRecord::StatementInvalid
  rescue RangeError
    nil
  end
end</code></pre></div> <div><br></div> <div><br></div> <div><b id="find_by!">find_by!</b></div> <div><br></div> <div>同find_by，但找不到记录会报错</div> <div><br></div> <div class=ever-code><pre><code>def find_by!(*args) # :nodoc:
  find_by(*args) or raise RecordNotFound.new("Couldn't find #{name}", name)
end</code></pre></div> <div><br></div> <div><br></div> <div><b id=find_by_xx>find_by_xx</b></div> <div><br></div> <div>首次执行会动态定义一个方法名为find_by_xx，方法体为find_by({xx: yy})的方法，即是效果同find_by。其运作如下</div> <div><br></div> <div><a href="/images/ad72d1/aea598.html" target=_blank><img src="/images/ad72d1/058cdc.png" alt="find_by_xx.html"></a></div> <div><br></div> <div><b id=where>where</b></div> <div><br></div> <div>返回的是ActiveRecord::Relation</div> <div><br></div></span> </div> </article> </section> <footer> </footer> </div> <script src="/javascripts/bundle-853f63ec.js"></script> </body> </html>