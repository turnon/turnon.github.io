<!doctype html> <html> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="chrome=1"> <title>Zp Yuan helper的加载</title> <link href="/bundle-1857e13f.css" rel=stylesheet /> <meta name=viewport content="width=device-width"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head> <body> <div class=wrapper> <header> <ul> <li class=current><a href="/index.html"><strong>笔记</strong></a></li> <li><a href="/statistics.html"><strong>统计</strong></a></li> <li><a href="/about.html"><strong>关于</strong></a></li> </ul> <div class=tags> <ol> <li> <a class=post-tag href="/index.html?tag=ruby"> <span>ruby</span> <span>61</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rails"> <span>rails</span> <span>31</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=metaprogramming"> <span>metaprogramming</span> <span>12</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=versus"> <span>versus</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=sinatra"> <span>sinatra</span> <span>7</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=test"> <span>test</span> <span>5</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rack"> <span>rack</span> <span>4</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=minitest"> <span>minitest</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=debug"> <span>debug</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=concurrency"> <span>concurrency</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=pattern"> <span>pattern</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=javascript"> <span>javascript</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jekyll"> <span>jekyll</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=middleman"> <span>middleman</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=functional"> <span>functional</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=tilt"> <span>tilt</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jquery"> <span>jquery</span> <span>1</span> </a> </li> </ol> </div> </header> <section> <article> <h1 class=post-title>helper的加载</h1> <span class=post-date>2017-04-16</span> <a class=post-tag href="/index.html?tag=rails">rails</a> <a class=post-tag href="/index.html?tag=ruby">ruby</a> <div> <span><div>想观察下helper是如何加载的，于是加个断点</div> <div><br></div> <div class=ever-code><pre><code>From: /home/z/test_rails/depot/app/helpers/application_helper.rb @ line 3 :

    1: binding.pry
    2:
 =&gt; 3: module ApplicationHelper
    4:   def something_in_cart?
    5:     @cart and not @cart.line_items.empty?
    6:   end
    7: end

[1] pry(main)&gt; _bsi_
=&gt; {0=&gt;#&lt;Binding:70142525638460 Object#&lt;top (required)&gt; /home/z/test_rails/depot/app/helpers/application_helper.rb:1&gt;,
 1=&gt;#&lt;Binding:70142997020320 ActiveSupport::Dependencies.block in load_file /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:477&gt;,
 2=&gt;#&lt;Binding:70142525785720 ActiveSupport::Dependencies.new_constants_in /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:662&gt;,
 3=&gt;#&lt;Binding:70142525861020 ActiveSupport::Dependencies.load_file /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:476&gt;,
 4=&gt;#&lt;Binding:70142996807940 ActiveSupport::Dependencies.block in require_or_load /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:375&gt;,
 5=&gt;#&lt;Binding:70142996741920 ActiveSupport::Dependencies.block in load_interlock /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:37&gt;,
 6=&gt;#&lt;Binding:70142526081600 ActiveSupport::Dependencies::Interlock#block in loading /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies/interlock.rb:12&gt;,
 7=&gt;#&lt;Binding:70142996611320 ActiveSupport::Concurrency::ShareLock#exclusive /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/concurrency/share_lock.rb:150&gt;,
 8=&gt;#&lt;Binding:70142996431800 ActiveSupport::Dependencies::Interlock#loading /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies/interlock.rb:11&gt;,
 9=&gt;#&lt;Binding:70142996261040 ActiveSupport::Dependencies.load_interlock /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:37&gt;,
 10=&gt;#&lt;Binding:70142996019940 ActiveSupport::Dependencies.require_or_load /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:358&gt;,
 11=&gt;#&lt;Binding:70142995857360 ActiveSupport::Dependencies.depend_on /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:336&gt;,
 12=&gt;#&lt;Binding:70142995630260 ApplicationController.require_dependency /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:252&gt;,
 13=&gt;#&lt;Binding:70142995556120 ApplicationController.block in modules_for_helpers /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/abstract_controller/helpers.rb:150&gt;,
 14=&gt;#&lt;Binding:70142995421940 ApplicationController.modules_for_helpers /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/abstract_controller/helpers.rb:145&gt;,
 15=&gt;#&lt;Binding:70142995222820 ApplicationController.modules_for_helpers /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/helpers.rb:93&gt;,
 16=&gt;#&lt;Binding:70142995114560 ApplicationController.helper /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/abstract_controller/helpers.rb:109&gt;,
 17=&gt;#&lt;Binding:70142990394940 ApplicationController.default_helper_module! /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/abstract_controller/helpers.rb:187&gt;,
 18=&gt;#&lt;Binding:70142990015780 ApplicationController.block in inherited /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/abstract_controller/helpers.rb:36&gt;,
 19=&gt;#&lt;Binding:70142989367180 ActionController::Base.inherited /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/abstract_controller/helpers.rb:36&gt;,
 20=&gt;#&lt;Binding:70142988773160 ActionController::Base.inherited /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionview-5.0.2/lib/action_view/layouts.rb:217&gt;,
 21=&gt;#&lt;Binding:70142988435320 ActionController::Base.inherited /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/rendering.rb:23&gt;,
 22=&gt;#&lt;Binding:70142985277140 ActionController::Base.inherited /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/metal/params_wrapper.rb:224&gt;,
 23=&gt;#&lt;Binding:70142984428220 ActionController::Base.block (2 levels) in with /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/abstract_controller/railties/routes_helpers.rb:7&gt;,
 24=&gt;#&lt;Binding:70142981935200 ActionController::Base.inherited /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_controller/railties/helpers.rb:5&gt;,
 25=&gt;#&lt;Binding:70142976438520 Object#&lt;top (required)&gt; /home/z/test_rails/depot/app/controllers/application_controller.rb:1&gt;,
 26=&gt;#&lt;Binding:70142526053680 ActiveSupport::Dependencies.block in load_file /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:477&gt;,
 27=&gt;#&lt;Binding:70142525963520 ActiveSupport::Dependencies.new_constants_in /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:662&gt;,
 28=&gt;#&lt;Binding:70142525848780 ActiveSupport::Dependencies.load_file /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:476&gt;,
 29=&gt;#&lt;Binding:70142525742220 ActiveSupport::Dependencies.block in require_or_load /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:375&gt;,
 30=&gt;#&lt;Binding:70142525643900 ActiveSupport::Dependencies.block in load_interlock /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:37&gt;,
 31=&gt;#&lt;Binding:70142525545500 ActiveSupport::Dependencies::Interlock#block in loading /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies/interlock.rb:12&gt;,
 32=&gt;#&lt;Binding:70142525446900 ActiveSupport::Concurrency::ShareLock#exclusive /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/concurrency/share_lock.rb:150&gt;,
 33=&gt;#&lt;Binding:70142525361420 ActiveSupport::Dependencies::Interlock#loading /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies/interlock.rb:11&gt;,
 34=&gt;#&lt;Binding:70142525239600 ActiveSupport::Dependencies.load_interlock /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:37&gt;,
 35=&gt;#&lt;Binding:70142525138400 ActiveSupport::Dependencies.require_or_load /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:358&gt;,
 36=&gt;#&lt;Binding:70142525025400 ActiveSupport::Dependencies.load_missing_constant /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:511&gt;,
 37=&gt;#&lt;Binding:70142524939660 Object.const_missing /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:203&gt;,
 38=&gt;#&lt;Binding:70142524828120 Object#&lt;top (required)&gt; /home/z/test_rails/depot/app/controllers/store_controller.rb:1&gt;,
 39=&gt;#&lt;Binding:70142524682320 ActiveSupport::Dependencies.block in load_file /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:477&gt;,
 40=&gt;#&lt;Binding:70142524647060 ActiveSupport::Dependencies.new_constants_in /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:662&gt;,
 41=&gt;#&lt;Binding:70142524575880 ActiveSupport::Dependencies.load_file /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:476&gt;,
 42=&gt;#&lt;Binding:70142524494820 ActiveSupport::Dependencies.block in require_or_load /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:375&gt;,
 43=&gt;#&lt;Binding:70142524409620 ActiveSupport::Dependencies.block in load_interlock /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:37&gt;,
 44=&gt;#&lt;Binding:70142524308840 ActiveSupport::Dependencies::Interlock#block in loading /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies/interlock.rb:12&gt;,
 45=&gt;#&lt;Binding:70142524258380 ActiveSupport::Concurrency::ShareLock#exclusive /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/concurrency/share_lock.rb:150&gt;,
 46=&gt;#&lt;Binding:70142524085460 ActiveSupport::Dependencies::Interlock#loading /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies/interlock.rb:11&gt;,
 47=&gt;#&lt;Binding:70142523974600 ActiveSupport::Dependencies.load_interlock /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:37&gt;,
 48=&gt;#&lt;Binding:70142523875140 ActiveSupport::Dependencies.require_or_load /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:358&gt;,
 49=&gt;#&lt;Binding:70142523766560 ActiveSupport::Dependencies.load_missing_constant /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:511&gt;,
 50=&gt;#&lt;Binding:70142523602100 Object.const_missing /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:203&gt;,
 51=&gt;#&lt;Binding:70142523557000 ActiveSupport::Inflector.block in constantize /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/inflector/methods.rb:268&gt;,
 52=&gt;#&lt;Binding:70142523471880 ActiveSupport::Inflector.constantize /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/inflector/methods.rb:266&gt;,
 53=&gt;#&lt;Binding:70142523367100 ActiveSupport::Dependencies::ClassCache#get /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:583&gt;,
 54=&gt;#&lt;Binding:70142523290820 ActiveSupport::Dependencies.constantize /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb:614&gt;,
 55=&gt;#&lt;Binding:70142523212960 ActionDispatch::Request#controller_class /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_dispatch/http/request.rb:81&gt;,
 56=&gt;#&lt;Binding:70142523060760 ActionDispatch::Routing::RouteSet::Dispatcher#controller /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_dispatch/routing/route_set.rb:44&gt;,
 57=&gt;#&lt;Binding:70142523018800 ActionDispatch::Routing::RouteSet::Dispatcher#serve /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_dispatch/routing/route_set.rb:30&gt;,
 58=&gt;#&lt;Binding:70142522925400 ActionDispatch::Journey::Router#block in serve /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_dispatch/journey/router.rb:39&gt;,
 59=&gt;#&lt;Binding:70142522801580 ActionDispatch::Journey::Router#serve /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_dispatch/journey/router.rb:26&gt;,
 60=&gt;#&lt;Binding:70142522699960 ActionDispatch::Routing::RouteSet#call /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_dispatch/routing/route_set.rb:725&gt;,
 61=&gt;#&lt;Binding:70142522594200 Rack::ETag#call /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/rack-2.0.1/lib/rack/etag.rb:25&gt;,
 # ...............</code></pre></div> <div><br></div> <div><br></div> <div>如无意外，应该是53到56之间的动作会加载controller，于是细看下55干的是什么</div> <div><br></div> <div class=ever-code><pre><code>def controller_class
  params = path_parameters

  if params.key?(:controller)
    controller_param = params[:controller].underscore
    params[:action] ||= 'index'
    const_name = "#{controller_param.camelize}Controller"
    ActiveSupport::Dependencies.constantize(const_name)
  else
    PASS_NOT_FOUND
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>要想知道加载哪个controller，需要从url中解析。而path_parameters这个方法并没有定义在当前类中，所以，进入该binding，检查path_parameters的source_location。不过，在当前类Request中method被重新定义过，所以需要拿Kernel的method来绑定当前binding来执行</div> <div><br></div> <div class=ever-code><pre><code>[2] pry(main)&gt; _bsi_[55]
=&gt; #&lt;Binding:70142523212960 ActionDispatch::Request#controller_class /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_dispatch/http/request.rb:81&gt;
[3] pry(main)&gt; _bsi_[55].eval('method(:path_parameters).source_location')
ArgumentError: wrong number of arguments (given 1, expected 0)
from /home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_dispatch/http/request.rb:177:in `method'
[4] pry(main)&gt; _bsi_[55].eval('method = Kernel.instance_method(:method); method.bind(self).call(:path_parameters).source_location')
=&gt; ["/home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/actionpack-5.0.2/lib/action_dispatch/http/parameters.rb", 71]</code></pre></div> <div><br></div> <div><br></div> <div>源码如下，但PARAMETERS_KEY也没定义在该源码文件中</div> <div><br></div> <div class=ever-code><pre><code># Returns a hash with the \parameters used to form the \path of the request.
# Returned hash keys are strings:
#
#   {'action' =&gt; 'my_action', 'controller' =&gt; 'my_controller'}
def path_parameters
  get_header(PARAMETERS_KEY) || set_header(PARAMETERS_KEY, {})
end</code></pre></div> <div><br></div> <div><br></div> <div>其实仅凭注释也知道它干啥，那索性执行下这个方法吧，应该没有副作用</div> <div><br></div> <div class=ever-code><pre><code>[8] pry(main)&gt; cd _bsi_[55]
[9] pry(#&lt;ActionDispatch::Request&gt;):1&gt; path_parameters
=&gt; {:controller=&gt;"store", :action=&gt;"index"}</code></pre></div> <div><br></div> <div><br></div> <div>因为目前访问的就是root，而root在route中被指向到store#index，所以也就这样了</div> <div><br></div> <div>接着再看回ActiveSupport::Dependencies.constantize</div> <div><br></div> <div class=ever-code><pre><code>[12] pry(#&lt;ActionDispatch::Request&gt;):1&gt; ActiveSupport::Dependencies.method(:constantize).source_location
=&gt; ["/home/z/.rbenv/versions/2.4.0/lib/ruby/gems/2.4.0/gems/activesupport-5.0.2/lib/active_support/dependencies.rb", 613]</code></pre></div> <div><br></div> <div><br></div> <div>简单来说，它就是用Inflector来查找类，然后cache起来</div> <div><br></div> <div class=ever-code><pre><code>require 'active_support/inflector'

module ActiveSupport
  module Dependencies
    extend self

    class ClassCache
      def initialize
        @store = Concurrent::Map.new
      end

      def get(key)
        key = key.name if key.respond_to?(:name)
        @store[key] ||= Inflector.constantize(key)
      end
    end

    Reference = ClassCache.new

    # Get the reference for class named +name+.
    # Raises an exception if referenced class does not exist.
    def constantize(name)
      Reference.get(name)
    end
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>而在调用栈中，仅出现两次const_missing，它们的参数分别是:StoreController和:ApplicationController</div> <div><br></div> <div class=ever-code><pre><code>[15] pry(main)&gt; cd _bsi_[50]
[16] pry(Object):1&gt; const_name
=&gt; :StoreController
[17] pry(Object):1&gt; exit
=&gt; Object
[18] pry(main)&gt; cd _bsi_[37]
[19] pry(Object):1&gt; const_name
=&gt; :ApplicationController</code></pre></div> <div><br></div> <div><br></div> <div>那么helper是在哪里加载呢？再检查下require_or_load，直接从最近的查起</div> <div><br></div> <div class=ever-code><pre><code>[21] pry(main)&gt; cd _bsi_[10]
[22] pry(ActiveSupport::Dependencies):1&gt; file_name
=&gt; "/home/z/test_rails/depot/app/helpers/application_helper"
[23] pry(ActiveSupport::Dependencies):1&gt; exit
=&gt; ActiveSupport::Dependencies
[31] pry(main)&gt; cd _bsi_[11]
[32] pry(ActiveSupport::Dependencies):1&gt; file_name
=&gt; "application_helper"</code></pre></div> <div><br></div> <div><br></div> <div>再往上，modules_for_helpers，其源码如下</div> <div><br></div> <div class=ever-code><pre><code>def modules_for_helpers(args)
  args += all_application_helpers if args.delete(:all)
  super(args)
end

# Returns a list of helper names in a given path.
#
#   ActionController::Base.all_helpers_from_path 'app/helpers'
#   # =&gt; ["application", "chart", "rubygems"]
def all_helpers_from_path(path)
  helpers = Array(path).flat_map do |_path|
    extract = /^#{Regexp.quote(_path.to_s)}\/?(.*)_helper.rb$/
    names = Dir["#{_path}/**/*_helper.rb"].map { |file| file.sub(extract, '\1'.freeze) }
    names.sort!
  end
  helpers.uniq!
  helpers
end

private
# Extract helper names from files in &lt;tt&gt;app/helpers/**/*_helper.rb&lt;/tt&gt;
def all_application_helpers
  all_helpers_from_path(helpers_path)
end</code></pre></div> <div><br></div> <div><br></div> <div>从这里可确定，它接受了值为"application"的参数</div> <div><br></div> <div class=ever-code><pre><code>[34] pry(main)&gt; cd _bs_[15]
[35] pry(ApplicationController):1&gt; all_application_helpers
=&gt; []
[36] pry(ApplicationController):1&gt; args
=&gt; ["application"]
[37] pry(ApplicationController):1&gt; helpers_path
=&gt; []</code></pre></div> <div><br></div> <div><br></div> <div>再super的话，就转化为文件名了，"#{arg.to_s.underscore}_helper"</div> <div><br></div> <div class=ever-code><pre><code>def modules_for_helpers(args)
  args.flatten.map! do |arg|
    case arg
    when String, Symbol
      file_name = "#{arg.to_s.underscore}_helper"
      begin
        require_dependency(file_name)
      rescue LoadError =&gt; e
        raise AbstractController::Helpers::MissingHelperError.new(e, file_name)
      end

      mod_name = file_name.camelize
      begin
        mod_name.constantize
      rescue LoadError
        # dependencies.rb gives a similar error message but its wording is
        # not as clear because it mentions autoloading. To the user all it
        # matters is that a helper module couldn't be loaded, autoloading
        # is an internal mechanism that should not leak.
        raise NameError, "Couldn't find #{mod_name}, expected it to be defined in helpers/#{file_name}.rb"
      end
    when Module
      arg
    else
      raise ArgumentError, "helper must be a String, Symbol, or Module"
    end
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>再往上，18和17是这样的，default_helper_module!会被调用，而所谓默认helper，就是当前controller名字转underscore，因此，helpers/目录中会有需有同名的helper的文件</div> <div><br></div> <div class=ever-code><pre><code>def default_helper_module!
  module_name = name.sub(/Controller$/, ''.freeze)
  module_path = module_name.underscore
  helper module_path
rescue LoadError =&gt; e
  raise e unless e.is_missing? "helpers/#{module_path}_helper"
rescue NameError =&gt; e
  raise e unless e.missing_name? "#{module_name}Helper"
end

# When the argument is a string or symbol, the method will provide the "_helper" suffix, require the file
# and include the module in the template class. The second form illustrates how to include custom helpers
# when working with namespaced controllers, or other cases where the file containing the helper definition is not
# in one of Rails' standard load paths:
#   helper :foo             # =&gt; requires 'foo_helper' and includes FooHelper
#   helper 'resources/foo'  # =&gt; requires 'resources/foo_helper' and includes Resources::FooHelper
def helper(*args, &amp;block)
  modules_for_helpers(args).each do |mod|
    add_template_helper(mod)
  end

  _helpers.module_eval(&amp;block) if block_given?
end</code></pre></div> <div><br></div> <div><br></div> <div>而default_helper_module!是在inherited时调用的</div> <div><br></div> <div class=ever-code><pre><code>def inherited(klass)
  helpers = _helpers
  klass._helpers = Module.new { include helpers }
  klass.class_eval { default_helper_module! } unless klass.anonymous?
  super
end</code></pre></div> <div><br></div> <div><br></div> <div>此时的子类是ApplicationController</div> <div><br></div> <div class=ever-code><pre><code>[41] pry(main)&gt; cd _bs_[19]
[42] pry(ActionController::Base):1&gt; klass
=&gt; ApplicationController</code></pre></div> <div><br></div> <div><br></div> <div>总结起来，加载StoreController时，因需要继承ApplicationController，所以加载它，而ApplicationController的继承链上有AbstractController::Helpers，它会导致在inherited时，根据子类的名称去helpers/下找helper，因此，ApplicationController会找到application_helper.rb，StoreController作为ApplicationController的子类，也会去找store_helper.rb</div> <div><br></div> <div>简单来说，按rails的约定，每个controller可有对应的helper在helpers/中，没有也可以。</div></span> </div> </article> </section> <footer> </footer> </div> <script src="/javascripts/bundle-853f63ec.js"></script> </body> </html>