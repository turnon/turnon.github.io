<!doctype html> <html> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="chrome=1"> <title>Zp Yuan jekyll的plugin加载时机</title> <link href="/bundle-1857e13f.css" rel=stylesheet /> <meta name=viewport content="width=device-width"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head> <body> <div class=wrapper> <header> <ul> <li class=current><a href="/index.html"><strong>笔记</strong></a></li> <li><a href="/statistics.html"><strong>统计</strong></a></li> <li><a href="/about.html"><strong>关于</strong></a></li> </ul> <div class=tags> <ol> <li> <a class=post-tag href="/index.html?tag=ruby"> <span>ruby</span> <span>51</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rails"> <span>rails</span> <span>21</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=metaprogramming"> <span>metaprogramming</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=versus"> <span>versus</span> <span>9</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=sinatra"> <span>sinatra</span> <span>7</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=test"> <span>test</span> <span>5</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rack"> <span>rack</span> <span>4</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=pattern"> <span>pattern</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=minitest"> <span>minitest</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=debug"> <span>debug</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=concurrency"> <span>concurrency</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jekyll"> <span>jekyll</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=javascript"> <span>javascript</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=middleman"> <span>middleman</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=functional"> <span>functional</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=tilt"> <span>tilt</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jquery"> <span>jquery</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=underscore"> <span>underscore</span> <span>1</span> </a> </li> </ol> </div> </header> <section> <article> <h1 class=post-title>jekyll的plugin加载时机</h1> <span class=post-date>2015-10-15</span> <a class=post-tag href="/index.html?tag=jekyll">jekyll</a> <a class=post-tag href="/index.html?tag=ruby">ruby</a> <div> <span><div>按官网说法，应该会比较靠前执行：</div> <div><br></div> <div>In your site source root, make a _plugins directory. Place your plugins here. Any file ending in *.rb inside this directory will be loaded before Jekyll generates your site</div> <div><br></div> <div>验证一下，先搜搜“_plugins”</div> <div><br></div> <div class=ever-code><pre><code>➜  jekyll  grep '_plugins' -Rn ./
./configuration.rb:12:      'plugins'       =&gt; '_plugins',
./plugin_manager.rb:38:        required_gems = Bundler.require(:jekyll_plugins) # requires the gems in this group only</code></pre></div> <div><br></div> <div><br></div> <div>进configuration.rb看看，它还有个哈希常量叫DEFAULTS</div> <div><br></div> <div class=ever-code><pre><code>module Jekyll
  class Configuration &lt; Hash

    # Default options. Overridden by values in _config.yml.
    # Strings rather than symbols are used for compatibility with YAML.
    DEFAULTS = {
      # Where things are
      'source'        =&gt; Dir.pwd,
      'destination'   =&gt; File.join(Dir.pwd, '_site'),
      'plugins'       =&gt; '_plugins',
      'layouts'       =&gt; '_layouts',
      'data_source'   =&gt;  '_data',
      'collections'   =&gt; nil,</code></pre></div> <div><br></div> <div><br></div> <div>搜搜DEFAULTS，看样子应该到plugin_manager.rb看看</div> <div><br></div> <div class=ever-code><pre><code>➜  jekyll  grep 'DEFAULTS' -Rn ./
./configuration.rb:8:    DEFAULTS = {
./configuration.rb:112:      override['source'] || self['source'] || DEFAULTS['source']
./configuration.rb:116:      override['quiet'] || self['quiet'] || DEFAULTS['quiet']
./plugin_manager.rb:88:      if (site.config['plugins'] == Jekyll::Configuration::DEFAULTS['plugins'])</code></pre></div> <div><br></div> <div><br></div> <div>发现plugin_manager.rb中，site.config['plugins']的site，是new时赋予的</div> <div><br></div> <div class=ever-code><pre><code>module Jekyll
  class PluginManager
    attr_reader :site

    # Create an instance of this class.
    #
    # site - the instance of Jekyll::Site we're concerned with
    #
    # Returns nothing
    def initialize(site)
      @site = site
    end</code></pre></div> <div><br></div> <div><br></div> <div>于是查查PluginManager.new</div> <div><br></div> <div class=ever-code><pre><code>➜  jekyll  grep 'PluginManager.new' -Rn ./
./site.rb:30:      self.plugin_manager = Jekyll::PluginManager.new(self)</code></pre></div> <div><br></div> <div><br></div> <div>到site.rb看看，它持有一个plugin_manager，并且在new时，需要传入config</div> <div><br></div> <div class=ever-code><pre><code>module Jekyll
  class Site
    attr_reader   :source, :dest, :config
    attr_accessor :layouts, :posts, :pages, :static_files,
                  :exclude, :include, :lsi, :highlighter, :permalink_style,
                  :time, :future, :unpublished, :safe, :plugins, :limit_posts,
                  :show_drafts, :keep_files, :baseurl, :data, :file_read_opts,
                  :gems, :plugin_manager

    attr_accessor :converters, :generators

    # Public: Initialize a new Site.
    #
    # config - A Hash containing site configuration details.
    def initialize(config)
      @config = config.clone

      %w[safe lsi highlighter baseurl exclude include future unpublished
        show_drafts limit_posts keep_files gems].each do |opt|
        self.send("#{opt}=", config[opt])
      end

      # Source and destination may not be changed after the site has been created.
      @source              = File.expand_path(config['source']).freeze
      @dest                = File.expand_path(config['destination']).freeze

      self.plugin_manager = Jekyll::PluginManager.new(self)
      self.plugins        = plugin_manager.plugins_path</code></pre></div> <div><br></div> <div><br></div> <div>查查Site.new</div> <div><br></div> <div class=ever-code><pre><code>➜  jekyll  grep 'Site.new' -Rn ./
./commands/doctor.rb:21:          site = Jekyll::Site.new(configuration_from_options(options))
./commands/build.rb:29:          site = Jekyll::Site.new(options)</code></pre></div> <div><br></div> <div><br></div> <div>到commands/build.rb看看，其中init_with_program是jekyll命令行的一系列钩子中的一环，当命令行执行“jekyll build”时，最终会执行“Jekyll::Commands::Build.process(options) ”</div> <div><br></div> <div class=ever-code><pre><code>module Jekyll
  module Commands
    class Build &lt; Command

      class &lt;&lt; self

        # Create the Mercenary command for the Jekyll CLI for this Command
        def init_with_program(prog)
          prog.command(:build) do |c|
            c.syntax      'build [options]'
            c.description 'Build your site'
            c.alias :b

            add_build_options(c)

            c.action do |args, options|
              options["serving"] = false
              Jekyll::Commands::Build.process(options)
            end
          end
        end

        # Build your jekyll site
        # Continuously watch if `watch` is set to true in the config.
        def process(options)
          Jekyll.logger.log_level = :error if options['quiet']

          options = configuration_from_options(options)
          site = Jekyll::Site.new(options)</code></pre></div> <div><br></div> <div><br></div> <div>Site.new时传入的options，先经configuration_from_options转换，此方法来自于父类Command，去看看</div> <div><br></div> <div class=ever-code><pre><code># Create a full Jekyll configuration with the options passed in as overrides
#
# options - the configuration overrides
#
# Returns a full Jekyll configuration
def configuration_from_options(options)
  Jekyll.configuration(options)
end</code></pre></div> <div><br></div> <div><br></div> <div>至此更明显了，它就是用于覆盖上面看到的DEFAULTS配置的。它引用了Jekyll.configuration来做，去看看</div> <div><br></div> <div class=ever-code><pre><code>def configuration(override = Hash.new)
  config = Configuration[Configuration::DEFAULTS]
  override = Configuration[override].stringify_keys
  unless override.delete('skip_config_files')
    config = config.read_config_files(config.config_files(override))
  end

  # Merge DEFAULTS &lt; _config.yml &lt; override
  config = Utils.deep_merge_hashes(config, override).stringify_keys
  set_timezone(config['timezone']) if config['timezone']

  config
end</code></pre></div> <div><br></div></span> </div> </article> </section> <footer> </footer> </div> <script src="/javascripts/bundle-853f63ec.js"></script> </body> </html>