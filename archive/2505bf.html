<!doctype html> <html> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="chrome=1"> <title>Zp Yuan The Flash</title> <link href="/bundle-1857e13f.css" rel=stylesheet /> <meta name=viewport content="width=device-width"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head> <body> <div class=wrapper> <header> <ul> <li class=current><a href="/index.html"><strong>笔记</strong></a></li> <li><a href="/statistics.html"><strong>统计</strong></a></li> <li><a href="/about.html"><strong>关于</strong></a></li> </ul> <div class=tags> <ol> <li> <a class=post-tag href="/index.html?tag=ruby"> <span>ruby</span> <span>48</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rails"> <span>rails</span> <span>16</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=metaprogramming"> <span>metaprogramming</span> <span>11</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=versus"> <span>versus</span> <span>10</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=javascript"> <span>javascript</span> <span>8</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=sinatra"> <span>sinatra</span> <span>7</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=pattern"> <span>pattern</span> <span>6</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rack"> <span>rack</span> <span>4</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=minitest"> <span>minitest</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=underscore"> <span>underscore</span> <span>3</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=debug"> <span>debug</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=concurrency"> <span>concurrency</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jekyll"> <span>jekyll</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=test"> <span>test</span> <span>2</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=middleman"> <span>middleman</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=functional"> <span>functional</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=tilt"> <span>tilt</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=java"> <span>java</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=rubinius"> <span>rubinius</span> <span>1</span> </a> </li> <li> <a class=post-tag href="/index.html?tag=jquery"> <span>jquery</span> <span>1</span> </a> </li> </ol> </div> </header> <section> <article> <h1 class=post-title>The Flash</h1> <span class=post-date>2017-03-29</span> <a class=post-tag href="/index.html?tag=rails">rails</a> <a class=post-tag href="/index.html?tag=ruby">ruby</a> <div> <span><div><b id="flash方法的来源">flash方法的来源</b></div> <div><br></div> <div>跟踪一下view中的flash方法如何运行</div> <div><br></div> <div class=ever-code><pre><code>&lt;% if binding.trace_tree(html: true, tmp: ['rails', 'view_flash.html']){flash[:alert]} %&gt;
  &lt;p id="notice"&gt;&lt;%= flash[:alert] %&gt;&lt;/p&gt;
&lt;% end %&gt;</code></pre></div> <div><br></div> <div><br></div> <div>调用栈如下</div> <div><br></div> <div><a href="/images/2505bf/44f456.html" target=_blank><img src="/images/2505bf/13097a.png" alt="view_flash.html"></a></div> <div><br></div> <div><br></div> <div>从源码来看，view的flash方法确实是共用controller的，这定义在ActionView::Helpers::ControllerHelper</div> <div><br></div> <div class=ever-code><pre><code>module ActionView
  module Helpers
    module ControllerHelper
      attr_internal :controller, :request

      delegate :request_forgery_protection_token, :params, :session, :cookies, :response, :headers,
               :flash, :action_name, :controller_name, :controller_path, :to =&gt; :controller</code></pre></div> <div><br></div> <div><br></div> <div>再检查下ActionView::Helpers::ControllerHelper如何mixin</div> <div><br></div> <div class=ever-code><pre><code>$ action_view git:(master) grep 'ControllerHelper' -rn *
helpers/controller_helper.rb:7:    module ControllerHelper #:nodoc:
helpers.rb:13:    autoload :ControllerHelper
helpers.rb:46:    include ControllerHelper</code></pre></div> <div><br></div> <div><br></div> <div>可见Helper会include ControllerHelper，然后ActionView::Base再include Helpers</div> <div><br></div> <div class=ever-code><pre><code>module ActionView
  class Base
    include Helpers, ::ERB::Util, Context</code></pre></div> <div><br></div> <div><br></div> <div>顺便看看哪些module/class有定义flash方法（这个倒不算很重要）</div> <div><br></div> <div class=ever-code><pre><code>irb(main):002:0&gt; ObjectSpace.find_all{|m| m.is_a? Module and m.instance_methods(false).include? :flash and m.name !~ /Test/}
=&gt; [ActionView::Helpers::ControllerHelper, ActionDispatch::Flash::FlashNow, ActionDispatch::Flash::RequestMethods]</code></pre></div> <div><br></div> <div><br></div> <div>而Request能调flash</div> <div><br></div> <div><a href="/images/2505bf/50e19f.png" target=_blank><img src="/images/2505bf/50e19f.png" type="image/png" style="height: auto;"></a></div> <div><br></div> <div><br></div> <div>是因为Request有mixin Flash::RequestMethods</div> <div><br></div> <div class=ever-code><pre><code>class Request
  prepend Flash::RequestMethods
end</code></pre></div> <div><br></div> <div><br></div> <div><b id="flash的运作">flash的运作</b></div> <div><br></div> <div>再跟踪一下如何在controller中设置flash</div> <div><br></div> <div class=ever-code><pre><code>class SessionsController &lt; ApplicationController
  def new
  end

  def create
    user = User.find_by(name: params[:name])
    if user.try(:authenticate, params[:password])
      session[:user_id] = user.id
    else
      binding.trace_tree(html: true, tmp: ['rails', 'controller_flash.html']) do
        flash[:alert] = "Invalid user/password combination"
        flash[:notice] = "Invalid user/password combination"
      end
    end
    redirect_to articles_url
  end</code></pre></div> <div><br></div> <div><br></div> <div>可见，在一次请求中FlashHash只会生成一次，并缓存与env中</div> <div><br></div> <div><a href="/images/2505bf/de83bd.png" target=_blank><img src="/images/2505bf/de83bd.png" type="image/png" style="height: auto;"></a></div> <div><br></div> <div><br></div> <div>源码如下</div> <div><br></div> <div class=ever-code><pre><code>class Flash
  KEY = 'action_dispatch.request.flash_hash'.freeze

  module RequestMethods

    def flash
      flash = flash_hash
      return flash if flash
      self.flash = Flash::FlashHash.from_session_value(session["flash"])
    end

    def flash=(flash)
      set_header Flash::KEY, flash
    end

    def flash_hash # :nodoc:
      get_header Flash::KEY
    end</code></pre></div> <div><br></div> <div><br></div> <div>再看看FlashHash的方法都会在什么时候被调用</div> <div><br></div> <div><a href="/images/2505bf/b7ce68.png" target=_blank><img src="/images/2505bf/b7ce68.png" type="image/png" style="height: auto;"></a></div> <div><br></div> <div><br></div> <div>可见ActionDispatch::Flash::FlashHash#to_session_value会在controller的dispatch被request的commit_flash调用</div> <div><br></div> <div>而dispatch如下，似乎所有响应都会commit_flash</div> <div><br></div> <div class=ever-code><pre><code>class Metal &lt; AbstractController::Base
  def dispatch(name, request, response) #:nodoc:
    set_request!(request)
    set_response!(response)
    process(name)
    request.commit_flash
    to_a
  end</code></pre></div> <div><br></div> <div><br></div> <div>而所谓commit_flash就是将flash塞到session中传回给client（假设整个session保存在cookie中）</div> <div><br></div> <div class=ever-code><pre><code>def commit_flash
  session    = self.session || {}
  flash_hash = self.flash_hash

  if flash_hash &amp;&amp; (flash_hash.present? || session.key?('flash'))
    session["flash"] = flash_hash.to_session_value
    self.flash = flash_hash.dup
  end

  if (!session.respond_to?(:loaded?) || session.loaded?) &amp;&amp; # (reset_session uses {}, which doesn't implement #loaded?)
      session.key?('flash') &amp;&amp; session['flash'].nil?
    session.delete('flash')
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>观察to_session_value以及再回头看看from_session_value</div> <div><br></div> <div class=ever-code><pre><code>class FlashHash
  include Enumerable

  def self.from_session_value(value)
    case value
    when FlashHash # Rails 3.1, 3.2
      flashes = value.instance_variable_get(:@flashes)
      if discard = value.instance_variable_get(:@used)
        flashes.except!(*discard)
      end
      new(flashes, flashes.keys)
    when Hash # Rails 4.0
      flashes = value['flashes']
      if discard = value['discard']
        flashes.except!(*discard)
      end
      new(flashes, flashes.keys)
    else
      new
    end
  end

  # Builds a hash containing the flashes to keep for the next request.
  # If there are none to keep, returns nil.
  def to_session_value
    flashes_to_keep = @flashes.except(*@discard)
    return nil if flashes_to_keep.empty?
    { 'discard' =&gt; [], 'flashes' =&gt; flashes_to_keep }
  end

  def initialize(flashes = {}, discard = []) #:nodoc:
    @discard = Set.new(stringify_array(discard))
    @flashes = flashes.stringify_keys
    @now     = nil
  end</code></pre></div> <div><br></div> <div><br></div> <div>其运作过程是，每次请求的首次调用flash方法时，会从session中抓取:flashes，然后生成FlashHash对象。</div> <div><br></div> <div>生成的方法是，在self.from_session_value中new，这时会给第二个参数传当前session中flash的keys，以示这些keys要discard掉</div> <div><br></div> <div>discard的时机是在塞回session时，对flash中这些key进行except</div> <div><br></div> <div>当然，如果取得的keys与本次想使用的key有重复，是不会删掉的：</div> <div><br></div> <div class=ever-code><pre><code>class FlashHash
  def []=(k, v)
    k = k.to_s
    @discard.delete k
    @flashes[k] = v
  end</code></pre></div> <div><br></div> <div><br></div> <div><b id="关于keep">关于keep</b></div> <div><br></div> <div>keep很简单，就是在@discard排除掉想保留的key，让它在下次请求仍然可用</div> <div><br></div> <div class=ever-code><pre><code>def keep(k = nil)
  k = k.to_s if k
  @discard.subtract Array(k || keys)
  k ? self[k] : self
end</code></pre></div> <div><br></div> <div><br></div> <div><b id="关于flash.now">关于flash.now</b></div> <div><br></div> <div>根据刚才的分析，在同一次请求中多次调用flash，用的都是同一个FlashHash，它缓存在env中，那么rails guide中对flash.now的介绍似乎就没有必要了</div> <div><br></div> <div class=ever-code><pre><code>class ClientsController &lt; ApplicationController
  def create
    @client = Client.new(params[:client])
    if @client.save
      # ...
    else
      flash.now[:error] = "Could not save client"
      render action: "new"
    end
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>但在源码的comment来看，其实是rails guide说得不够完整</div> <div><br></div> <div class=ever-code><pre><code># Sets a flash that will not be available to the next action, only to the current.
#
#     flash.now[:message] = "Hello current action"
#
# This method enables you to use the flash as a central messaging system in your app.
# When you need to pass an object to the next action, you use the standard flash assign (&lt;tt&gt;[]=&lt;/tt&gt;).
# When you need to pass an object to the current action, you use &lt;tt&gt;now&lt;/tt&gt;, and your object will
# vanish when the current action is done.</code></pre></div> <div><br></div> <div><br></div> <div>now的与非now的区别在于not be available to the next action</div> <div><br></div> <div>为了达到这个目的，now方法会用FlashNow来包装FlashHash，是任何[]=操作都会同时把key记录为discard，这样在FlashHash#to_session_value时这些key/value就不会在去到session中，并由下次请求的的from_session_value获取到</div> <div><br></div> <div class=ever-code><pre><code>class FlashHash
  def now
    @now ||= FlashNow.new(self)
  end

  def discard(k = nil)
    k = k.to_s if k
    @discard.merge Array(k || keys)
    k ? self[k] : self
  end
end

class FlashNow
  def []=(k, v)
    k = k.to_s
    @flash[k] = v
    @flash.discard(k)
    v
  end
end</code></pre></div> <div><br></div> <div><br></div> <div>所以render会搭配使用flash.now，而redirect搭配使用flash</div></span> </div> </article> </section> <footer> </footer> </div> <script src="/javascripts/bundle-853f63ec.js"></script> </body> </html>